  ----------------------------
  Установка ППРБ.ИМ / МЭИМ
  Руководство администратора
  ----------------------------

для версии ППРБ R7.1.X

Версия от 12.12.2018

Москва

2018

# Оглавление

Оглавление 2

Назначение документа 4

История изменений 4

Обновление параметров настройка режима Stand-In 6

Добавление нового технологического пользователя для МЭИМ - uvdousr. 6

Добавление нового технологического пользователя для ИМ - ufsursuusr. 6

Введение 7

Общие сведения 7

Термины и сокращения 7

Связанные документы 8

1 Комплект поставки 10

2 Общий перечень задач 12

3 Задачи Администратора ОС 13

4 Задачи Администратора ТЯ 15

4.1 Установка и настройка Конфигуратора 15

4.2 Установка и настройка модуля «Журналирование» 15

4.2.1 Настройка журналирования для ИМ 15

4.2.2 Настройка журналирования для МЭИМ 18

4.3 Подключение подсистемы доступа 19

5 Задачи Администратора ИМ 23

5.1 Установка и настройка сервера приложений WildFly 23

5.1.1 Установка Java 1.8 23

5.1.2 Установка WildFly 24

5.1.3 Настройка WildFly 24

5.1.4 Развертывание ZeroMQ на Wildfly 25

5.1.5 Развертывание ECP-MANAGE (для БиКрипт) на Wildfly 25

5.1.6 Установка модулей 26

5.1.7 Настройка использования сервиса межкластерной маршрутизации 27

5.1.8 Настройка режима Stand-In 27

5.1.9 Запуск WildFly 29

5.1.10 Установка seap-lib 29

5.2 Настройка GridGain 31

5.3 Установка модуля Integrator 33

5.4 Настройки модуля Integrator при установке GridGain и WildFly на
разные виртуальные машины 34

5.5 Установка адаптеров на сервер приложений 35

5.5.1 Установка Ansible 35

5.5.2 Конфигурирование Ansible 35

5.5.3 Запуск установки адаптеров 36

5.6 Установка ИМ в Конфигураторе 37

5.7 Настройка ИМ в Конфигураторе 40

5.7.1 Настройка артефакта для ИМ 40

5.7.2 Настройка артефакта для МЭИМ 46

5.7.3 Ручная настройка адаптеров (необязательный пункт) 48

5.7.4 SSL-аутентификация 54

5.7.5 Параметры транспортной библиотеки MQ (необязательный пункт) 54

5.7.6 Обновление настроек интеграционного взаимодействия 55

5.8 Настройка MQ-транспорта для ИМ 56

5.9 Настройка MQ-транспорта для МЭИМ 59

5.10 Установка СКЗИ БиКрипт 60

5.11 Настройка SSL для адаптеров 60

6 Задачи Администратора Kafka 62

7 Настройка конфигуратора для распределения адаптеров по кластеру. 63

# Назначение документа

Данный документ содержит информацию о создании инфраструктуры и порядке
установки и настройки интеграционного слоя ППРБ, который может быть
представлен одним из двух модулей: миграционного экземпляра
интерфейсного модуля ППРБ (МЭИМ) или интерфейсного модуля - ИМ ППРБ.

Документ предназначен для администраторов, выполняющих установку,
настройку и сопровождение АС ППРБ ИМ / МЭИМ. Выполнение всех описанных
действий разделено по ролям администраторов различных уровней:

-   Администратор ОС;

-   Администратор Kafka;

-   Администратор ТЯ;

-   Администратор ИМ.

## История изменений 

| **№ ред.** | **Дата**   | **Автор**    | **Изменения**            |
|------------|------------|-----------------|--------------------------|
| 0.1        | 04.04.2017 | Диваков А.В.    | Первоначальный документ  |
| 0.2        | 21.04.2017 | Диваков А.В. | Устранены замечания, полученные от Белова Е.А. 20.04.2017 |
| 0.3        | 04.05.2017 | Диваков А.В. | Добавлено предусловие выполнения шагов установки в разделе 2. |
| 0.4        | 15.06.2017 | Диваков А.В. | Добавлен раздел по настройке и установке транспортного слоя MQ (ранее описание настройки было в отдельном файле notes_EFS.txt)Добавлено указание на файл whitelist_greenfield.xml в составе дистрибутива.|
| 0.5        | 16.10.2017 | Диваков А.В. | Разделение руководства по ролям администраторов  различного уровня. |
| 0.6        | 13.11.2017 | Диваков А.В. | Добавлен подраздел «Настройка MQ-транспорта  для МЭИМ» |
| 0.7        | 17.11.2017 | Диваков А.В. | Добавлено описание установки сервера приложений WildFly и информация по настройкам  для работы в режиме Stand-In. |
| 0.8        | 28.11.2017 | Диваков А.В. | Обновление данных по настройке БиКрипт. |
| 0.9        | 13.12.2017 | Диваков А.В. | Добавлено описание настройки файловых и JDBC-адаптеров |
| 0.10       | 21.12.2017 | Диваков А.В. | Обновление подраздела 5.5 «Настройка MQ-транспорта для ИМ» |
| 0.11       | 27.12.2017 | Диваков А.В. | Обновление подраздела 4.3.6 «Настройка режима Stand-In» - добавление настроек. |
| 0.12       | 29.12.2017 | Диваков А.В. | Добавление подразделов по настройке GridGain и   модуля Integrator. |
| 0.13       | 11.01.2018 | Диваков А.В. | Добавление настроек GridGain. |
| 0.14       | 24.01.2018 | Диваков А.В. | Исправление замечаний от  ЦСПС (Блюменкранц Алексей). |
| 0.15       | 06.02.2018 | Диваков А.В. | Добавление параметров -D IGNITE_NO_SHUTDOWN_HOOK, -DlogbackDisableSer       vletContainerInitializer в файл настроек WildFly standalone.conf. |
| 0.16       | 13.02.2018 | Диваков А.В. | Добавление новых технологических пользователей для МЭИМ. |
| 0.17       | 21.03.2018 | Диваков А.В. | Добавление новых технологических пользователей для МЭИМ -  esbfs99usr, cod3dvk99usr. |
| 0.18       | 13.04.2018 | Диваков А.В. | Добавление описания изменений настроек адаптеров в связи с изменением правил хранения паролей, добавление настроек журналирования для Интегратора, мелкие правки по тексту. |
| 0.19       | 20.04.2018 | Диваков А.В. | Добавление раздела 5.4 для описания настроек МЭИМ в связи с тем, что WildFly и GridGain могут находиться на разных машинах. |
| 0.20       | 10.05.2018 | Диваков А.В. | Добавление нового технологического пользователя для МЭИМ - dm99usr. |
| 0.21       | 14.05.2018 | Диваков А.В. | Добавление описания установки seap-lib. |
| 0.22       | 30.05.2018 | Диваков А.В. | Добавление нового технологического пользователя для МЭИМ - afn99usr. |
| 0.23       | 19.06.2018 | Диваков А.В. | ### Обновление парамет ров настройка режима Stand-In    |
| 0.24       | 21.06.2018 | Диваков А.В. | ### Добавление нового технологического пользователя для МЭИМ - uvdousr. |
| 0.25       | 19.09.2018 | Диваков А.В. | Добавление подраздела по предварительной настройке ОС в раздел задач администратора ОС. |
| 0.26       | 31.10.2018 | Диваков А.В. | Добавление подраздела с описанием настроек Интегратора для работы с сервисом межкластерной маршрутизации |
| 0.27       | 14.11.2018 | Диваков А.В. | Добавление нового технологического пользователя для ИМ - ufs ursuusr. |
| 0.28       | 12.12.2018 | Онохин А.В.  | Добавлена информация понастройки распределенияадаптеров по кластеру.|

# Введение

## Общие сведения

На момент разработки данного документа в ППРБ существуют два модуля,
реализующие взаимодействие прикладных модулей ППРБ и внешних систем:

-   интерфейсный модуль (ИМ) предназначен для организации постоянного
    интеграционного взаимодействия между ППРБ и целевыми внешними
    системами;

-   миграционный экземпляр интерфейсного модуля (МЭИМ) предназначен для
    организации временного интеграционного взаимодействия между ППРБ и
    внешними системами, признанными нецелевыми и мигрирующими в ППРБ.

ИМ / МЭИМ реализован посредством следующих компонентов:

-   транспортный слой JDBC;

-   транспортный слой MQ;

-   транспортный слой SOAP;

-   транспортный слой SMTP;

-   транспортный слой передачи файлов;

-   транспортный слой Kafka;

-   адаптерная подсистема, реализуемая на базе компонента ППРБ --
    «Интегратор».

Адаптерная подсистема ИМ / МЭИМ представляет собой набор адаптеров,
реализуемых на основе компонента ППРБ -- «Интегратор». Адаптеры
реализуют специфику взаимодействия между интегрируемыми системами (ППРБ
и внешними АС).

## Термины и сокращения   

**Таблица** **1. Термины и сокращения**


| **Термин /Сокращение** | **Определение**                            |
|------------------------|--------------------------------------------|
| **Ansible**            | Система управления конфигурациями,          используется для установки интеграционных   модулей.                                   |  
| **GreenField**         | Выделенный контур (ИФТ/ПСИ/ПРОМ),           предназначенный для пилотирования           (например, перед тиражированием на весь     пром)                                      |  
| **GridGain**           | Промежуточное программное обеспечение для   обработки в оперативной памяти больших      данных в распределённой среде.             |  
| **Hyperic HQ**         | Система мониторинга, предназначена для      конфигурирования ППРБ, в том числе и ИМ /   МЭИМ                                       |  
| **Stand-In**           | Дополнительный контур -- экземпляр ППРБ,    который запускается в работу при            возникновении аварийных ситуаций или        проведении технических работ в основном     контуре ППРБ и невозможности продолжения    работы сервисов Банка в основном контуре    ППРБ.                                      |  
| **WAS**                | IBM WebSphere Application Server -- сервер  приложений                                 |  
| **WildFly**            | Сервер приложений, используется как замена  WAS                                        |  
| **JVM**                | Java Virtual Machine                       |  
| **Kafka**              | Apache Kafka -- программный брокер          сообщений                                  |  
| **RHEL**               | Red Hat Enterprise Linux                   |  
| **БД**                 | База данных                                |  
| **БОК**                | База открытых ключей                       |  
| **ППРБ**               | Платформа поддержки развития бизнеса -      совокупность программных средств, методик,  регламентов, направленная на унификацию и   упрощение процессов разработки,             тестирования, вывода в промышленную         эксплуатацию бизнес-приложений.            |  
| **ТЯ, ППРБ ТЯ**        | Технологическое ядро ППРБ                  |  
| **МЭИМ**               | Миграционный экземпляр интерфейсного        модуля ППРБ                                |  
| **ПО**                 | Программное обеспечение                    |  
| **ИМ**                 | Интерфейсный модуль ППРБ                   |  
| **ОАСП**               | Отдел администрирования серверов            приложений                                 |  
| **ОС**                 | Операционная система                       |  
| **ОФР**                | Ответственный за формирование релизов ИМ /  МЭИМ ППРБ, сотрудник Отдела федеративных    интеграционных решений Департамента         развития аналитических решений и системных  сервисов: Диваков Андрей Вячеславович,      e-mail: <SBT-Divakov-AV@mail.ca.sbrf.ru>,                                               тел.внутр.: 8-789-18887                    |  
| **СКЗИ**               | Средство криптографической защиты           информации                                 |  
| **ТФС**                | Транспортная файловая система              |  
| **УСЦВР**              | Управление сопровождения централизованных   вычислительных ресурсов                    |  
| **ФПСУ**               | Программно-аппаратный комплекс фильтрации   пакетов сетевого уровня                    |  

## Связанные документы   

**Таблица** **2. Связанные документы**

| **№ п/п** | **Наименование документа**                      | **Документ** |
|-----------|-------------------------------------------------|--------------|
| 1.        | Взаимодействие с внешними системами             |              |
| 2.        | Руководство по установке и настройке ПО ТЯ ППРБ |              |
| 3.        | Руководство по администрированию Apache Kafka   |              |
| 4.        | Файл конфигурации для WildFly standalone.conf   |              |
| 5.        | Файл конфигурации для WildFly standalone.xml    |              |

# Комплект поставки 

Новая версия самого приложения «Интегратор» и новые версии адаптеров и
API предоставляются разработчиками ППРБ ИМ в составе каталога поставки,
который содержит необходимые дистрибутивы и инструкции для развертывания
ИМ / МЭИМ на сервере. Расположение дистрибутивов на ресурсах ФПД и
Nexus: для каждой новой версии необходимо уточнять у ОФР.

Структура вложенных каталогов дистрибутива:

1)  **bicr** -- содержит библиотеки для работы с СКЗИ БиКрипт;

2)  **config-struct** -- содержит файлы моделей конфигурации транспортов
    ИМ, а также дополнительные универсальные настройки адаптеров;

3)  **docs --** содержит общую документацию по установке ИМ / МЭИМ (в
    том числе данное руководство), инструкцию по настройке и установке
    транспортного слоя MQ для данного дистрибутива; документы
    предназначены для прикладных разработчиков и администраторов;

4)  **environment --** содержит файлы конфигурации, которые можно
    использовать в качестве образца настроек. Помимо основного файла со
    списком устанавливаемых адаптеров (whitelist.xml) содержит файл
    whitelist_greenfield.xml, в котором приведен список устанавливаемых
    адаптеров на стенд GreenField;

5)  **gridgain --** содержит файл настроек GridGain;

6)  **installation-scripts --** содержит файлы, необходимые для
    установки Ansible;

7)  **integrator --** содержит war-файл приложения «Интегратор»;

8)  **integrator-repository** -- содержит комплект скомпилированных
    компонентов системного ядра ППРБ. Состав артефактов данного каталога
    после компиляции всех модулей:

    -   **external-system--api** -- для хранения jar-файлов интерфейсов
        (API) внешних систем*;*

    -   **in-adapters** -- для хранения jar-файлов адаптеров входящих
        сообщений от внешних систем*;*

    -   **module-api** -- для хранения jar-файлов интерфейсов (API)
        прикладных модулей*;*

    -   **out-adapters** -- для хранения jar-файлов адаптеров исходящих
        сообщений к внешним системам;

    -   **transport-libraries** -- для хранения jar-файлов транспортных
        библиотек;

9)  **mq** -- содержит скрипты для установки транспортного слоя MQ;

10) **profiles** -- содержит файлы конфигурации платформы для ИМ / МЭИМ;

11) **schema** -- содержит xsd-схемы валидации файлов транспортных
    настроек адаптеров;

12) **wf** -- содержит файлы для настройки сервера приложений WildFly.

# Общий перечень задач

Общий перечень задач, составляющий процесс установки ИМ / МЭИМ, с
распределением по ролям администраторов различного уровня приведен в
таблице 3.

**Таблица** **3. Распределение задач по ролям**
  
| **№ п/п** | **Задача**                       | **Роль**            |
|-----------|----------------------------------|---------------------|
| 1.        | Настройка ОС                     | > Администратор ОС  |  
| 2.        | Установка и настройка Конфигуратора           | Администратор ТЯ    |
| 3.        | Установка и настройка модуля  «Журналирование»    | Администратор ТЯ    |
| 4.        | Подключение подсистемы доступа   | Администратор ТЯ    |  
| 5.        | Установка и настройка WildFly    | Администратор ИМ    |  
| 6.        | Настройка GridGain               | Администратор ИМ    |  
| 7.        | Установка модуля Integrator      | Администратор ИМ    |  
| 8.        | Установка ИМ в WildFly           | Администратор ИМ    |  
| 9.        | Установка адаптеров на сервер приложений   | Администратор ИМ    |
| 10.       | Установка и настройка ИМ в Конфигураторе      | Администратор ИМ    |
| 11.       | Настройка MQ                     | Администратор ИМ    |  
| 12.       | Установка СКЗИ БиКрипт           | Администратор ИМ    |  
| 13.       | Настройка системы мониторинга    | Администратор ИМ    |  
| 14.       | Настройка SSL для адаптеров      | Администратор ИМ    |  
| 15.       | Установка и настройка Kafka      | Администратор Kafka |  

# Задачи Администратора ОС

До начала непосредственной установки ИМ / МЭИМ ППРБ со стороны
администратора ОС требуется выполнить следующие действия:

1\) для установки и настройки транспортного слоя MQ на ИМ на целевых
серверах для каждого MQ-менеджера («M99.IM.GATEWAY.CLS1» и
«M99.IM.GATEWAY.CLS2») создать файловую систему и пользователей в
одноименных группах:

```
groupadd prb99usr
groupadd ufs99usr
groupadd dsa99usr
groupadd sv99usr
groupadd ech99usr
groupadd dumbusr
groupadd ufsursuusr
useradd -g prb99usr prb99usr
useradd -g ufs99usr ufs99usr
useradd -g dsa99usr dsa99usr
useradd -g sv99usr sv99usr
useradd -g ech99usr ech99usr
useradd -g dumbusr dumbusr
useradd -g ufsursuusr ufsursuusr
``````

**ВНИМАНИЕ!**

Установка и настройка транспортного слоя необходима только при
необходимости прямых взаимодействий между внешними АС (ЕФС) и ППРБ без
использования КСШ.

2\) Для установки и настройки транспортного слоя MQ на МЭИМ на целевых
серверах для MQ-менеджера «M99.ESBMS.GATEWAY1» создать файловую систему
и пользователей в одноименных группах:

```
groupadd ibs38usr
groupadd ups99usr
groupadd esbmsusr
groupadd crm99usr
groupadd cod99usr
groupadd fs99usr
groupadd ucp99usr
groupadd vpl99usr
groupadd dumbusr
groupadd esbfs99usr
groupadd cod3dvk99usr
groupadd dm99usr
groupadd afn99usr
groupadd uvdousr
useradd -g ibs38usr ibs38usr
useradd -g ups99usr ups99usr
useradd -g esbmsusr esbmsusr
useradd -g crm99usr crm99usr
useradd -g cod99usr cod99usr
useradd -g fs99usr fs99usr
useradd -g ucp99usr ucp99usr
useradd -g vpl99usr vpl99usr
useradd -g dumbusr dumbusr
useradd -g esbfs99usr  esbfs99usr
useradd -g cod3dvk99usr cod3dvk99usr
useradd -g dm99usr dm99usr
useradd -g afn99usr afn99usr
useradd -g uvdousr uvdousr
``````

1)  переопределить ограничения на максимальное число открытых файлов и
    создаваемых потоков:

-   переопределить лимиты для пользователя, из-под которого будет
    запускаться ИМ/МЭИМ -- «prb99usr» и «esbmsusr» соответственно с
    помощью команды «ulimit»:

```
ulimit --Sn \<количество файлов\>
ulimit --Hn \<количество файлов\>
ulimit --Su \<количество потоков\>
ulimit --Hu \<количество потоков\>
``````

-   переопределить лимиты для всей ОС в целом таким образом, чтобы
    значения сохранялись после возможной перезагрузки сервера:

```
#Максимальное количество процессов в ОС
kernel.pid_max = \<значение\>

#Максимальное количество потоков в ОС (по сути, то же, что и pid_max)
kernel.threads-max = \<значение\>

#Максимальное количество регионов памяти, доступных процессу
vm.max_map_count = \<значение\>
``````

**ПРИМЕЧАНИЕ:**

Значение параметра «max_map_count» должно быть в 2 раза больше значения
параметра «pid_max».

Значение параметра «pid_max» должно быть больше значения максимального
количества создаваемых потоков для пользователя, из-под которого будет
запускаться ИМ/МЭИМ, на величину количества потоков, необходимых самой
ОС.

# Задачи Администратора ТЯ

До начала непосредственной установки ИМ / МЭИМ ППРБ со стороны
администратора ТЯ требуется выполнить следующие действия:

-   установка и настройка Конфигуратора;

-   установка и настройка модуля «Журналирование»;

-   подключение подсистемы доступа.

## Установка и настройка Конфигуратора

Описание установки и настройки сервера «Конфигуратор» приведено в
подразделе 6.4 документа «Руководство по установке и настройке ПО ТЯ
ППРБ» (см. Таблицу 2 подраздела [Связанные
документы](#_Связанные_документы)).

## Установка и настройка модуля «Журналирование»

Описание установки и настройки модуля «Журналирование» приведено в
подразделе 6.6.3 документа «Руководство по установке и настройке ПО ТЯ
ППРБ» (см. Таблицу 2 подраздела [Связанные
документы](#_Связанные_документы)).

### Настройка журналирования для ИМ

После выполнения настроек журналирования, описанных в «Руководстве по
установке и настройке ПО ТЯ ППРБ», необходимо добавить настройки для ИМ.

1\) Создать канал «IM» со следующими параметрами (см. Рисунок 1):

-   Идентификатор = «IM»;

-   Сфера действия -- Модуль = «integrator»;

-   Реализация = «ППРБ (kafka)»;

-   Параметры:

    **Общие**

    \- Сообщение как JSON = «V» (установить галочку).

    **Параметры соединения Apache Kafka**

    \- Bootstrap Servers --- указать через запятую IP-адреса всех
    брокеров Kafka кластера Cloudera вместе с портом:
    10.xxx.xxx.xxx:9093,...;
    \- Kafka Topic = «int_eventlog»;
    \- Acks = «1».

    **Параметры безопасности Apache Kafka**

    \- Security Protocol = «SSL»;
    \- SSL Protocol = «TLS»;
    \- SSL Truststore = «V» (установить галочку);
    \- SSL Truststore Type = «JKS».

![](media/image6.png){width="6.488194444444445in"
height="6.304166666666666in"}

Рисунок 1

2\) Создать 3 категории (см. Рисунок 2).

-   Категория 1, параметры:

> \- Стенд = \<пусто\>;  
> \- Модуль = «integator»;  
> \- Узел = \<пусто\>;  
> \- Категория = «IntegratorLogger»;  
> \- Описание = \<пусто\>;  
> \- IM = «ALL»;  
> \- console = «ALL»;  
> \- kafka = «INFO»;  
> \- orchestrator = «OFF»;  
> \- rolling_file = «OFF».

-   Категория 2, параметры:

> \- Стенд = \<пусто\>;  
> \- Модуль = «integator»;  
> \- Узел = \<пусто\>;  
> \- Категория = «com.sbt.integrator»;  
> \- Описание = \<пусто\>;  
> \- IM = \<пусто\>  
> \- console = « INFO »  
> \- kafka = «INFO»  
> \- orchestrator = «OFF»  
> \- rolling_file = «OFF».

-   Категория 3, параметры:

> \- Стенд = \<пусто\>  
> \- Модуль = «integator»  
> \- Узел = \<пусто\>  
> \- Категория = \<пусто\>  
> \- Описание = \<пусто\>  
> \- IM = « OFF»  
> \- console = «OFF»  
> \- kafka = «OFF»  
> \- orchestrator = «OFF»  
> \- rolling_file = «OFF».

![](media/image7.png)  

Рисунок 2

### Настройка журналирования для МЭИМ

После выполнения настроек журналирования, описанных в «Руководстве по
установке и настройке ПО ТЯ ППРБ», необходимо добавить настройки для
МЭИМ.

1\) Создать канал «IM» со следующими параметрами:

-   Идентификатор = «IM»;

-   Сфера действия -- Модуль = «integrator_ms»;

-   Реализация = «ППРБ (kafka)»;

-   Параметры:

    **Общие**

    \- Сообщение как JSON = «V» (установить галочку).

    **Параметры соединения Apache Kafka**

    \- Bootstrap Servers --- указать через запятую IP-адреса всех
    брокеров Kafka кластера Cloudera вместе с портом:
    10.xxx.xxx.xxx:9093,...;

    \- Kafka Topic = «int_eventlog»;

    \- Acks = «1».

    **Параметры безопасности Apache Kafka**

> \- Security Protocol = «SSL»  
> \- SSL Protocol = «TLS»  
> \- SSL Truststore = «V» (установить галочку)  
> \- SSL Truststore Type = «JKS».

2\) Создать 2 категории (аналогично Рисунку 2 для ИМ).

-   Категория 1, параметры:

> \- Стенд = \<пусто\>  
> \- Модуль = «integrator_ms»  
> \- Узел = \<пусто\>  
> \- Категория = «IntegratorLogger»  
> \- Описание = \<пусто\>  
> \- IM = «ALL»  
> \- console = «ALL»  
> \- kafka = «INFO»  
> \- orchestrator = «OFF»  
> \- rolling_file = «OFF».

-   Категория 2, параметры:

> \- Стенд = \<пусто\>  
> \- Модуль = «integrator_ms»  
> \- Узел = \<пусто\>  
> \- Категория = «com.sbt.integrator»  
> \- Описание = \<пусто\>  
> \- IM = \<пусто\>  
> \- console = « INFO »  
> \- kafka = «INFO»  
> \- orchestrator = «OFF»  
> \- rolling_file = «OFF».

## Подключение подсистемы доступа

Для подключения ИМ / МЭИМ к подсистеме доступа необходимо создать
технологического пользователя подсистемы доступа, от имени которого
интеграционный модуль будет вызывать методы API прикладных модулей. Для
создания такого пользователя используется АРМ «Управление доступом»
серверной части подсистемы доступа. Подробнее подсистема доступа описана
в подразделе 6.8 документа «Руководство по установке и настройке ПО ТЯ
ППРБ» (см. Таблицу 2 подраздела [Связанные
документы](#_Связанные_документы)).

Для подключения интеграционного модуля к подсистеме доступа необходимо
выполнить следующие шаги:

-   создать в подсистеме доступа роль с правами на вызов API всех
    прикладных модулей, предоставляющих сервисы внешним системам;

-   создать пользователя и назначить ему эту роль;

-   включить использование подсистемы доступа интеграционным модулем в
    конфигурационном файле ППРБ и указать там же учётную запись
    пользователя, созданного на предыдущем шаге.

Для создания роли необходимо войти в веб-интерфейс подсистемы доступа, в
дереве навигации слева выбрать пункт **«Роли»** (см. Рисунок 3).

![](media/image8.png){width="5.372093175853018in"
height="2.721388888888889in"}

Рисунок 3

В дереве ролей в правой части страницы выберите корневой элемент
**«Роли»** и нажмите кнопку **«Создать»**. Задайте роли следующие
параметры:

**Название роли**

integrator

**Тип роли**

Пользователь

После создания роли выберите её в списке ролей и нажмите кнопку
**«Добавить права»**. Добавьте роли следующие права:

-   **«AccessSystem\\Доступ через API\\Загрузка прав внешних модулей»**;

-   Все права из группы **«integrator\\Права на доступ к API прикладных
    модулей»**;

-   Право **«Выгрузка прав внешних систем»**.

**ПРИМЕЧАНИЕ:**

группа и права внутри неё создаются при запуске интеграционного модуля.
Если в вашей подсистеме доступа нет этой группы, убедитесь, что
интеграционный модуль был запущен хотя бы один раз.

Далее необходимо создать пользователя и назначить ему созданную ранее
роль.

**ПРИМЕЧАНИЕ:**

При работе подсистемы доступа в режиме интеграции с СУДИР создание
пользователя и назначение ему роли выполняется в СУДИР.

Если режим интеграции с СУДИР отключен, то необходимо в дереве навигации
слева выбрать пункт **«Пользователи»**, на панели справа нажать кнопку
**«Создать»** (см. Рисунок 4).

![](media/image9.png){width="6.496527777777778in"
height="3.7541601049868767in"}

Рисунок 4

Задайте пользователю следующие параметры:

**Логин**

integrator

**Тип пользователя**

Пользователь

Остальные параметры можно ввести произвольно. Далее выберите созданного
пользователя в списке пользователей и нажмите «**Роли**». Добавьте
пользователю роль, созданную ранее.

Далее необходимо включить использование подсистемы доступа
интеграционным модулем в конфигурации (Конфигуратор ППРБ, консоли
конфигурации Hyperic HQ). Для этого необходимо в группе **«Настройки
подсистемы доступа (Access)»** изменить значение параметра
**«disabled»** на «**false»** и заполнить следующие свойства (см.
Рисунок 3):

![](media/image10.png){width="6.48071084864392in"
height="1.183999343832021in"}

Рисунок 5

-   «**username»** -- имя технологического пользователя подсистемы
    > доступа, учётную запись которого использует интеграционный модуль;

-   «**password»** -- пароль технологического пользователя подсистемы
    > доступа, учётную запись которого использует интеграционный модуль;

-   **«ip»** -- IP-адрес рабочей станции, на которой расположена
    > серверная часть подсистемы доступа.

В случае добавления нового прикладного модуля, доступного для входящих
запросов от внешних систем необходимо добавить соответствующее право
роли, назначенной технологическому пользователю интеграционного модуля
(т.е. роли, созданной по инструкции выше). Для этого после добавления
необходимых компонентов перезапустите интеграционный модуль. После этого
в группе прав «**integrator\\Права на доступ к API прикладных модулей»**
появится новое право, соответствующее добавленному API. Чтобы дать
интеграционному модулю возможность вызывать это API, добавьте это право
в роль технологического пользователя интеграционного модуля.

# Задачи Администратора ИМ

Cо стороны администратора ИМ требуется выполнить следующие действия:

-   установка и настройка сервера приложений WildFly;

-   настройка GridGain;

-   установка модуля Integrator;

-   установка ИМ в WildFly (при использовании WildFly в качестве сервера
    приложений);

-   установка адаптеров на сервер приложений;

-   установка и настройка ИМ в Конфигураторе;

-   настройка MQ-транспорта;

-   установка СЗКИ БиКрипт;

-   подключение подсистемы доступа;

-   настройка системы мониторинга ИМ / МЭИМ;

-   настройка журналирования работы ИМ / МЭИМ.

## Установка и настройка сервера приложений WildFly

### Установка Java 1.8 

Установленная последняя версия Java 1.8 X на сервере, на который
планируется устанавливать WildFly - исходное требование к КТС. Для
проверки установленной версии Java необходимо на целевом сервере
выполнить команду в консольном режиме (см. Рисунок 4):

\> java -version

![](media/image11.png){width="5.311805555555556in"
height="0.5756944444444444in"}

Рисунок 6

Для работы SSL в файле «\$JAVA_HOME/lib/security/java.security»
обязательно необходимо закомментировать строки:

\#jdk.tls.legacyAlgorithms= \\

\# K_NULL, C_NULL, M_NULL, \\

\# DHE_DSS_EXPORT, DHE_RSA_EXPORT, DH_anon_EXPORT, DH_DSS_EXPORT, \\

\# DH_RSA_EXPORT, RSA_EXPORT, \\

\# DH_anon, ECDH_anon, \\

\# RC4_128, RC4_40, DES_CBC, DES40_CBC, \\

\# 3DES_EDE_CBC

### Установка WildFly

Загрузить архив с WildFly 10.1.0.Final по ссылке
<http://wildfly.org/downloads/>

или из:
[\\\\loko1\\vol4\\FR_SBT_PDA\\Folder10\\PPRB\\Soft\\WildFly](file:///\\loko1\vol4\FR_SBT_PDA\Folder10\PPRB\Soft\WildFly)
на сервер, на который будет выполняться установка WildFly в папку
«/usr/WF/WF_PPRB». Распаковать архив в текущую папку.

### Настройка WildFly

1\) Создать папку
«/usr/WF/WF_PPRB/modules/system/layers/base/org/postgresql/main» на
сервере, куда планируется установить WildFly.

2\) Загрузить из Нексуса (<http://sbtnexus.ca.sbrf.ru:8081/nexus>)
библиотеку драйвера для postgresql-9.2-1002.jar в созданную папку.

3\) Установить права доступа для файла postgresql-9.2-1002.jar как
read/write/execute для пользователя, от которого будет производиться
запуск WildFly и группы, к которой он принадлежит (774).

4\) В созданной папке создать файл module.xml со следующим содержимым: 

\<module xmlns=\"urn:jboss:module:1.0\" name=\"org.postgresql\"\> \
  \<resources\> \
      \<resource-root path=\"postgresql-9.2-1002.jar\"/\> \
  \</resources\> \
  \<dependencies\> \
      \<module name=\"javax.api\"/\> \
      \<module name=\"javax.transaction.api\"/\> 

\<dependencies\> 

5\) Прописать в файл
«/usr/WF/WF_PPRB/standalone/configuration/standalone.xml» в строку под
тегом «\<subsystem xmlns=\"urn:jboss:domain:ee:4.0\"\>» следующий тег:

\<global-modules\>

\<module name=\"org.postgresql\" slot=\"main\"/\>

\</global-modules\>

Здесь же добавить тэг с новым драйвером:

\<subsystem xmlns=\"urn:jboss:domain:datasources:4.0\"\>

\<datasources\>

\<drivers\>

...

\<driver name=\"postgresql\" module=\"org.postgresql\"\>

\<driver-class\>org.postgresql.Driver\</driver-class\>

\</driver\>

\</drivers\>

\</datasources\>

\</subsystem\>

6\) Загрузить библиотеку ojdbc6-11.2.0.3.jar по ссылке:
http://sbtnexus.ca.sbrf.ru:8081/nexus/content/repositories/Platform_thirdparty/ojdbc6/ojdbc6/11.2.0.3/ojdbc6-11.2.0.3.jar
и положить ее в директорию «/usr/WF/WF_PPRB/standalone/lib/ext».

**ПРИМЕЧАНИЕ:**

настройка WildFly для работы с Oracle требуется для сохранения
возможности возврата к варианту использования Oracle в механизме
логирования.

### Развертывание ZeroMQ на Wildfly

1\) В директорию «/usr/WF/WF_PPRB/standalone/lib/ext» на сервере, где
установлен WildFly, скопировать файлы дистрибутива ZeroMQ
(jzmq-3.1.0.jar; libjzmq.so; zmq.jar) из дистрибутива ТЯ ППРБ
соответствующей версии.

2\) Установить права доступа для файлов как «read/write/execute» для
пользователя и группы (774).

3\) Указать в файле в директории «/usr/WF/WF_PPRB/bin/standalone.conf»,
в блоке «JAVA_OPTS» строку:

-Djava.library.path=/usr/WF/WF_PPRB/standalone/lib/ext

4\) В папке ««/usr/WF/WF_PPRB/modules/system/layers/base» создать
директорию «org/zeromq/jzmq/main». Скопировать туда файлы «module.xml» и
«jzmq-3.1.0.jar» из папки «/wf/zeromq». Установить права доступа для
файла «jzmq-3.1.0.jar» как «read/write/execute» для юзера и группы
(774).

5\) Прописать «jzmq-3.1.0.jar» в «global_modules», для этого в файле
«standalone.xml» под тегом «\<subsystem
xmlns=\"urn:jboss:domain:ee:4.0\"\>»: создать следующий тег:

\<global-modules\>

**\<module name=\"org.zeromq.jzmq\" slot=\"main\"/\>**

\<module name=\"org.postgresql\" slot=\"main\"/\>

\</global-modules\>

### Развертывание ECP-MANAGE (для БиКрипт) на Wildfly

1\) В папке «/usr/WF/WF_PPRB/modules/system/layers/base» создать
директорию: «com/sbt/ecp-manage/main».

2\) Скопировать в данную директорию все из папки «wf/ecp-manage»
дистрибутива ИМ.

3\) В файле «/usr/WF/WF_PPRB/bin/standalone.conf» в разделе «JAVA_OPTS»
добавить строку:

-DpathToBicrypt=/usr/WF/WF_PPRB/standalone/lib/ext

, где «/usr/WF/WF_PPRB/standalone/lib/ext» - путь к папке с библиотеками
БиКрипт.

4\) Прописать в файле
«/usr/WF/WF_PPRB/standalone/configuration/standalone.xml» строку в теге
«global-modules» (выделено жирным):

\<global-modules\>

**\<module name=\"com.sbt.ecp-manage\" slot=\"main\"/\>**

\<module name=\"org.zeromq.jzmq\" slot=\"main\"/\>

\<module name=\"org.postgresql\" slot=\"main\"/\>

\</global-modules\>

### Установка модулей

**Custodian**

Для установки модуля «Custodian» необходимо поместить
файл «custodian-distr-impl-ear-\<version\>.ear» из состава дистрибутива
ТЯ ППРБ соответствующей версии в
папку «/usr/WF/WF_PPRB/standalone/deployments».

[**MessageDispatcher**](http://confluence.ca.sbrf.ru/pages/viewpage.action?pageId=145929561)

Для установки модуля «MessageDispatсher» необходимо:

1\) Поместить файл «transport-md-ear-\<version\>.ear» из состава
дистрибутива ТЯ ППРБ соответствующей версии в
папку «/usr/WF/WF_PPRB/standalone/deployments».

2\) Создать файл хранилища ключей и файл доверенного хранилища
сертификатов.

3\) Подложить файлы \*.jks, по пути указанному в настройках артефакта
«message-dispatcher» в Конфигураторе:

message-dispatcher\@kafka.ssl.truststore.location=trust.jks

message-dispatcher\@kafka.ssl.keystore.location=keystore.jks

**ПРИМЕЧАНИЕ:**

Если артефакт «message-dispatcher» в Конфигураторе не находится, то
необходимо получить права на его просмотр у администратора Hyperic.

### Настройка [использования сервиса межкластерной маршрутизации](https://confluence.ca.sbrf.ru/pages/viewpage.action?pageId=991920200)

Сервис межкластерной маршрутизации - компонент ППРБ ТЯ, созданный для
возможности обращения к прикладным фабрикам и сервисам, размещенным в
нескольких зонах обслуживания. Сервис определяет зону обслуживания, в
которую будет направлен вызов межмодульного API, на основе аргументов
вызываемого метода.

Для настройки использования Интегратором сервиса межкластерной
маршрутизации необходимо:

1)  Установить приложение--клиент для сервиса межкластерной индексации -
    cci-mmt-impl-ear-\<version\>.ear.

Для этого скопировать файл «cci-mmt-impl-ear-\<version\>.ear» из состава
дистрибутива ТЯ ППРБ соответствующей версии в произвольную папку на
сервере, на котором установлен WildFly.

В папке «/usr/WF/WF_PPRB/bin» выполнить команды:

> jboss-cli.bat \--connect \--command=\"deploy \--disabled /\<Путь к
> артефакту\>/cci-mmt-impl-ear-\<version\>.ear\"
>
> jboss-cli.bat \--connect \--command=\"deployment-overlay link
> \--name=seap-lib-8.1 \--deployments=cci-mmt-impl\*.war\"
>
> jboss-cli.bat \--connect \--command=\"deploy
> --name=cci-mmt-impl-ear-\<version\>.ear\"

2)  Установить приложение -- сервис межкластерной маршрутизации -
    cc-routing-war-\<version\>.war.

Для этого скопировать файл «cc-routing-war-\<version\>.war» из состава
дистрибутива ТЯ ППРБ соответствующей версии в произвольную папку на
сервере, на котором установлен WildFly.

В папке «/usr/WF/WF_PPRB/bin» выполнить команду:

> jboss-cli.bat \--connect \--command=\"deploy /\<Путь к
> артефакту\>/cc-routing-war-\<version\>.war\"

### Настройка режима Stand-In

В файле «/usr/WF/WF_PPRB/standalone/bin/standalone.conf» необходимо
добавить параметры:

Для ИМ:

-Dintegrator.type=IM

-Dintegrator.rest.port=8443

Для МЭИМ:

-Dintegrator.type= MEIM

-Dintegrator.rest.port=8443

, где

-Dintegrator.type - определяет тип экземпляра интегратора (ИМ / МЭИМ).
Параметр используется для управления работой ИМ / МЭИМ при переключении
режима работы ППРБ (основноой, stand-in);

-Dintegrator.rest.port - определяет порт, на котором поднимается
rest-сервис интегратора.

В папку «/usr/WF/WF_PPRB/server/config/dir» необходимо положить файл
хранилища ключей и файл доверенного хранилища сертификатов, созданные
ранее (п.4.3.5).

В файле «/usr/WF/WF_PPRB/standalone/configuration/standalone.xml»
необходимо заменить секцию

\<security-realm name=\"ApplicationRealm\"\>\</security-realm\>

на

\<security-realm name=\"ApplicationRealm\"\>

\<server-identities\>

\<ssl\>

\<keystore path=\"server.keystore\"
relative-to=\"jboss.server.config.dir\" keystore-password=\"\<пароль\>\"
key-password=\"\<пароль\>\"/\>

\</ssl\>

\</server-identities\>

\<authentication\>

\<local default-user=\"\$local\" allowed-users=\"\*\"
skip-group-loading=\"true\"/\>

\<truststore path=\"client.truststore\"
relative-to=\"jboss.server.config.dir\"
keystore-password=\"\<пароль\>\"/\>

\<properties path=\"application-users.properties\"
relative-to=\"jboss.server.config.dir\"/\>

\</authentication\>

\<authorization\>

\<properties path=\"application-roles.properties\"
relative-to=\"jboss.server.config.dir\"/\>

\</authorization\>

\</security-realm\>

, где:

\- в теге «keystore» в атрибуте «path» укажите имя файла хранилища
ключей, в атрибуте «keystore-password» - пароль на хранилище, в атрибуте
«key-password» - пароль на ключ;

\- в теге «truststore» в атрибуте «path» укажите имя файла доверенного
хранилища сертификатов, в атрибуте «keystore-password» - пароль на
хранилище.

Также в данном файле необходимо в теге «https-listener» добавить
атрибуты:

security-realm=\"ApplicationRealm\"

verify-client=\"REQUIRED\"

enable-http2=\"true\" (при его отсутствии)

, в подраздел «filters» добавить тег:

\<rewrite name=\"http-to-https\" redirect=\"true\"
target=\"https://\<ip-адрес хоста\>:8443%U\"/\>

, в подраздел «host name=\"default-host\" alias=\"localhost\"» добавить
тег:

\<filter-ref name=\"http-to-https\"
predicate=\"equals(%p,\<http-порт\>)\"/\>

, где

\- ip-адрес хоста - ip-адрес сервера, на котором установлен WildFly;

\- http-порт - порт, по которому доступен http. Значение необходимо
взять из файла «/usr/WF/WF_PPRB/standalone/configuration/standalone.xml»
из параметра «http»:

\<socket-binding name=\"http\" port=\"\$  \"/\>

Образец файла «standalone.xml» приведен в Таблице 2 подраздела
[Связанные документы](#_Связанные_документы)).

### Запуск WildFly

Для запуска СП WildFly необходимо выполнить \\bin\\standalone.sh. При
успешном запуске модуля в сервере приложений WildFly в логах запуска
будет отображаться сообщение вида:

WildFly Full 10.1.0.Final (WildFly Core 1.0.2.Final) started in 63312ms.

### Установка seap-lib

Seap-lib нужен для того, чтобы версию платформы ППРБ ТЯ можно было
обновлять без пересборки прикладных модулей, в том числе и Интегратора.
Достигается это за счет использования режима overlay в WildFly.

Для установки необходимо:

1\) убедиться, что файл «transport-md-ear-\<version\>.ear» из состава
дистрибутива ТЯ ППРБ соответствующей версии скопирован в
папку «/usr/WF/WF_PPRB/standalone/deployments».

2\) Скопировать файл seap-lib-\<version\>.ear из состава дистрибутива
ТЯ ППРБ соответствующей версии в произвольную папку на сервере, где
установлен WildFly, и распаковать его.

**ВНИМАНИЕ!**

Перед выполнением следующего шага необходимо убедиться, что:

\- корректно установлена переменная «JBOSS_HOME» либо папка
«/usr/WF/WF_PPRB /bin» добавлена в PATH;

\- папка «lib» в папке, куда был распакован архив на предыдущем шаге,
содержит jar-файлы, которые необходимо добавить в overlay;

\- Wildlfy запущен.

3\) Создать overlay, для чего выполнить скрипт «create-overlay.sh» из
папки, в которой был распакован архив на предыдущем шаге.

4\) Задеплоить файл приложения Интегратора «integrator-\<version\>.war»
в выключенном виде, выполнив команду из папки «\$JBOSS_HOME/bin»:

jboss-cli.bat \--connect \--command=\"deploy \--disabled
/usr/WF/WF_PPRB/standalone/deployments/integrator-\<version\>.war\"

5\) Включить overlay для приложения Интегратора, выполнив команду из
папки «\$JBOSS_HOME/bin»:

jboss-cli.bat \--connect \--command=\"deployment-overlay link
\--name=seap-lib \--deployments=integrator-\<version\>.war\"

6\) Включить файл приложения Интегратора, выполнив команду из папки
«\$JBOSS_HOME/bin»:

jboss-cli.bat \--connect \--command=\"deploy
\--name=integrator-\<version\>..war\"

## Настройка GridGain

1\) Убедиться, что на сервере установлен GridGain версии 8.4.1-p6. Для
этого на целевом сервере из командной строки можно выполнить команду:

\> ps ax \| grep gridgain

В выводе появится строка с информацией о запущенном процессе.

2\) На целевом сервере из командной строки создать системную переменную
окружения:

\> \$ export IGNITE_HOME='/usr/WF/gridgain'

3\) В файле «/usr/WF/WF_PPRB/standalone/configuration/standalone.xml»
конфигурации WildFly добавить строку для блока \<system-properties\>:

\<property name=\"IGNITE_HOME\" value=\"/usr/WF/gridgain\"/\>

, где значение атрибута «value» - путь до папки, содержащей лицензию на
GridGain.

4\) Поместить в папку «/usr/WF/gridgain/config» файл
«default-config.xml» из папки «gridgain» в составе дистрибутива ИМ/МЭИМ.

5\) В скопированном файле «default-config.xml» подставить актуальное
значение ip-адресов серверов, на которых установлен GridGain:

\<property name=\"discoverySpi\"\>

\<bean class=\"org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi\"\>

\<property name=\"ipFinder\"\>

\<bean
class=\"org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder\"\>

\<property name=\"addresses\"\>

\<list\>

\<value\>ip-адрес_1:47500..47509\</value\>

\<value\>ip-адрес_N:47500..47509\</value\>

\</list\>

\</property\>

\</bean\>

\</property\>

\</bean\>

\</property\>

6\) Скопировать библиотеку «file-transport-util-1.3.jar» из папки
«wf/ecp-manage» в составе дистрибутива ИМ/МЭИМ в папку
«/usr/WF/gridgain/libs».

7\) На каждом сервере ИМ/МЭИМ нужно запустить по две ноды GridGain с
помощью скрипта «ignite.sh» из папки «/usr/WF/gridgain/bin».
Предварительно нужно убедиться, что все узлы ИМ/МЭИМ остановлены.
Успешность запуска GridGain можно определить по записи в логе
«/usr/WF/gridgain/work/log/\*.log»:

\[14:23:03\] Topology snapshot \[ver=20, servers=4, clients=0, CPUs=8,
heap=4.0GB\]

8\) Чтобы установить время жизни объектов в кэше равным 60 минутам,
отредактировать следующие блоки в файле
«/usr/WF/gridgain/config/default-config.xml»:

\<property name=\"expiryPolicyFactory\"\>

\<bean class=\"javax.cache.expiry.CreatedExpiryPolicy\"
factory-method=\"factoryOf\"\>

\<constructor-arg\>

\<bean class=\"javax.cache.expiry.Duration\"\>

\<constructor-arg value=\"**MINUTES**\"/\>

\<constructor-arg value=\"**60**\"/\>

\</bean\>

\</constructor-arg\>

\</bean\>

\</property\>

9\) Чтобы установить максимальный размер кэша равным 200 Гб, добавить
следующий блок внутрь тэга «IgniteConfiguration» в этом же файле:

\<property name=\"dataStorageConfiguration\"\>

\<bean
class=\"org.apache.ignite.configuration.DataStorageConfiguration\"\>

\<property name=\"defaultDataRegionConfiguration\"\>

\<bean
class=\"org.apache.ignite.configuration.DataRegionConfiguration\"\>

\<property name=\"name\" value=\"Default_Region\"/\>

\<!\-- Установка размера 200 Гб \--\>

\<property name=\"maxSize\" value=\"\#{**200L** \* 1024 \* 1024 \*
1024}\"/\>

\</bean\>

\</property\>

\</bean\>

\</property\>

10\) Для настройки параметров JVM необходимо добавить следующие строки в
файл «/usr/WF/gridgain/bin/ignite.sh» после блока JVM options:

\#Максимальный размер кучи 4 Гб, начальный 2 Гб, размер metaspace 256 Мб

JVM_OPTS=\"-server --Xms2g -Xmx4g -XX:MaxMetaspaceSize=256m\"

JVM_OPTS=\"\$JVM_OPTS -Dsun.net.inetaddr.ttl=60
-Djava.net.preferIPv4Stack=true\"

\#Сборка мусора

JVM_OPTS=\"\$JVM_OPTS -XX:+UseG1GC  -XX:MaxGCPauseMillis=2000
-XX:+ScavengeBeforeFullGC -XX:+AlwaysPreTouch -XX:+DisableExplicitGC\"

JVM_OPTS=\"\$JVM_OPTS -XX:InitiatingHeapOccupancyPercent=30
-XX:G1HeapRegionSize=32m\"

\#Игнайт

JVM_OPTS=\"\$JVM_OPTS -DIGNITE_QUIET=false\"

11\) Поместить в папку «/usr/WF/gridgain» файл «gridgain-license.xml» из
сетевой папки
«\\\\loko1\\vol4\\FR_SBT_PDA\\Folder10\\PPRB\\Soft\\GridGain\\Лицензия
GG для версии 8.1.1 и выше».

После изменения настроек ноду GridGain необходимо перезапустить.

## Установка модуля Integrator

Для установки модуля Integrator необходимо:

1\) Поместить файл «integrator-\<версия\>.war» из папки «integrator»
дистрибутива ИМ/МЭИМ в папку «/usr/WF/WF_PPRB/standalone/deployments» на
целевом сервере.

Установка дистрибутива с интеграционными точками сводится к обновлению
директории «integrator_repository».

2\) Настроить параметры для запуска модуля «Integrator»:

в файле в папке «/usr/WF/WF_PPRB/bin/standalone.conf», в разделе
«JAVA_OPTS» необходимо добавить и сконфигурировать следующие строки:

JAVA_OPTS=\"-server -Xms20g -Xmx20g -XX:MetaspaceSize=1g

-XX:MaxMetaspaceSize=1g\"

JAVA_OPTS=\"\$JAVA_OPTS

-Djboss.modules.system.pkgs=\$JBOSS_MODULES_SYSTEM_PKGS

-Djava.awt.headless=true -Djava.net.preferIPv4Stack=true\"

\#Сборка мусора

JAVA_OPTS=\"\$JAVA_OPTS -XX:+UseG1GC -XX:MaxGCPauseMillis=2000

-XX:+ScavengeBeforeFullGC -XX:+AlwaysPreTouch -XX:+DisableExplicitGC\"

JAVA_OPTS=\"\$JAVA_OPTS -XX:InitiatingHeapOccupancyPercent=30

-XX:G1HeapRegionSize=32m\"

\# Настройки ПО

JAVA_OPTS=\"\$JAVA_OPTS -Dfile.encoding=UTF-8
-Djava.net.preferIPv4Stack=true -Dconfig-store.disabled=false
-Djndi-store.disabled=true\"

JAVA_OPTS=\"\$JAVA_OPTS --Dconfig

-store\@jdbc.url=jdbc:postgresql://\<ip-адрес хоста\>:5432/cfg\"

JAVA_OPTS=\"\$JAVA_OPTS -Dconfig-store\@jdbc.login=\<Логин1\>

--Dconfig -store\@jdbc.password=\<Пароль1\>\"

-Dconfig -store\@crypto.password=\<Пароль2\>\"

JAVA_OPTS=\"\$JAVA_OPTS -Djava.security.auth.login.config=

-Djboss.as.management.blocking.timeout=3600

-Djboss.bind.address.management=0.0.0.0\"

JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=0.0.0.0
-Dnode.id=\$IP_NODE\"

JAVA_OPTS=\"\$JAVA_OPTS -Dcustodian.channel.authenticationEnabled=false

-Dcustodian.logger.baseDir=/opt/pprb/logs
-Dcustodian.channel.jmx.port=1111 -Dcustodian.safeModeEnabled=true\"

JAVA_OPTS=\"\$JAVA_OPTS -DIGNITE_NO_SHUTDOWN_HOOK=true\"

JAVA_OPTS=\"\$JAVA_OPTS
--DlogbackDisableServletContainerInitializer=true"

\# Открытие порта JMX для мониторинга потоков JAVA

JAVA_OPTS=\"\$JAVA_OPTS -Dcom.sun.management.jmxremote

-Dcom.sun.management.jmxremote.port=1100

-Dcom.sun.management.jmxremote.authenticate=false

-Dcom.sun.management.jmxremote.ssl=false\"

, где:

\- Xms20g -Xmx20g -XX:MetaspaceSize=1g -XX:MaxMetaspaceSize=1g --
рекомендуемые значения по выделению оперативной памяти для WildFly,

\- «ip-адрес хоста» -- адрес сервера, на котором установлен WildFly,

\- «Логин1», «Пароль1» -- логин и пароль для подключения к СУБД, которую
использует Конфигуратор,

\- «Пароль2» -- ключ для шифрования пароля для подключения к СУБД.
Обязателен, если config-store.disabled=false.

**ПРИМЕЧАНИЕ:**

Для МЭИМ дополнительно в настройку

«JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=0.0.0.0
-Dnode.id=\$IP_NODE\"»

нужно добавить параметры:

«-Dmodule.id=integrator_ms -Dgroup.id=ms», т.е. получится:

«JAVA_OPTS=\"\$JAVA_OPTS -Djboss.bind.address=0.0.0.0
-Dmodule.id=integrator_ms -Dgroup.id=ms -Dnode.id=\$IP_NODE»

Образец файла «standalone.conf» приведен в Таблице 2 подраздела
[Связанные документы](#_Связанные_документы)).

## Настройки модуля Integrator при установке GridGain и WildFly на разные виртуальные машины

Для примера описания настроек взят КТС с 4мя виртуальными машинами: 2
для GridGain, 2 для WildFly.

В Конфигураторе ППРБ в настройке
«integrator\@Cluster\[GROUP\]/ipAddresses=»  указать ip-адреса обеих
виртуальных машин для GridGain.

На каждой виртуальной машине с GridGain в конфигурационный файл
«default-config.xml» в папке папку «/usr/WF/gridgain/config» должны быть
прописаны ip-адреса других виртуальных машин с GridGain.

На каждой виртуальной машине с WildFly необходимо в файле
«/usr/WF/WF_PPRB/standalone/configuration/standalone.xml» конфигурации
WildFly добавить строку для блока \<system-properties\>:

\<property name=\"IGNITE_HOME\" value=\"/usr/WF/gridgain\"/\>

, где значение атрибута «value» - путь до папки, содержащей лицензию на
GridGain на каждой виртуальной машине с WildFly.

Очень важно чтобы версия библиотек GridGain в WildFly соответствовала
версии установленного GridGain.

Данные настройки применимы и к ИМ, и к МЭИМ.

## Установка адаптеров на сервер приложений

Установка адаптеров производится с помощью системы управления
конфигурациями Ansible и представляет собой запуск ansible-сценария
(playbook).

### Установка Ansible

Необходимо установить Ansible на сервер, с которого планируется запуск
установки адаптеров (ОС Windows не поддерживается). Дистрибутив и
документацию по Ansible можно найти на интернет-ресурсе
<https://www.ansible.com> .

Далее на сервере, на который установлен Ansible, в корневой папке «/usr»
создать произвольную папку (например, «integrator») и распаковать в нее
архив с дистрибутивом ИМ / МЭИМ. Необходимые для использования Ansible
файлы входят в состав дистрибутива ИМ / МЭИМ и располагаются в каталоге
«installation-scripts».

### Конфигурирование Ansible

В папке, созданной на предыдущем шаге, в файле профиля
«installation-scripts /playbooks/group_vars/\<название_профиля\>.yml»
необходимо указать настройки для окружения. В папке уже находятся два
файла профилей окружения для стендов разработки (dev.yml) и ИФТ
(ift.yml), можно внести правки в один из них, либо создать новый на базе
шаблона:

+----------------------------------------------------------------------+
| remote_user: \<имя пользователя сервера, на который планируется      |
| установка ИМ\>\                                                      |
| \                                                                    |
| environment:\                                                        |
| file: \<название файла настроек окружения из environment\>\          |
| list: \<название файла whitelist-a устанавливаемых ИМ из             |
| environment\>\                                                       |
| \                                                                    |
| integrator:\                                                         |
| repository: \<путь к удаленному репозиторию\> (исключая              |
| /integrator-repository)\                                             |
| properties: \<путь к файлу platform-config.properties\>              |
|                                                                      |
| appServer:                                                           |
|                                                                      |
| **Далее настройки для используемого сервера приложений**             |
|                                                                      |
| was:\                                                                |
| profile: \<Путь к профилю WAS, на котором установлен интегратор\>\   |
| server: \<Имя WAS сервера\>                                          |
|                                                                      |
| **ИЛИ:**                                                             |
|                                                                      |
| wildFly:                                                             |
|                                                                      |
| starter: \<Путь к исполняемому файлу сервера standalone.sh или       |
| domain.sh\>                                                          |
|                                                                      |
| configurator:                                                        |
|                                                                      |
| **Блок обязателен для режима configurator\                           |
| **loader_url: \<путь к loader\>                                      |
|                                                                      |
| rmi_connection: \<адрес для соединения с Конфигуратором\>\           |
| rmi_keystore: \<наименование хранилища ключей\>\                     |
| rmi_keystore_password: \<пароль для хранилища\>                      |
+----------------------------------------------------------------------+

Для установки на ПСИ / ПРОМ также можно либо использовать готовый шаблон
ift.yml и вносить правки в него, либо создать новый.

Далее укажите настройки для соединения с сервером, на который
планируется установка ИМ: они находятся в файлах
«installation-scripts/\*.hosts» в папке, куда был распакован дистрибутив
ИМ / МЭИМ. Под символом «\*» в данном контексте подразумевается вариант
названия файла. Файлы «*\*.*hosts» служат исключительно для соединения
Ansible с удаленными хостами (или localhost) и включают в себя следующие
параметры:

+----------------------------------------------------------------------+
| **\[*профиль*\] -** название профиля настройки окружения в           |
| соответствии с наименование файлов «\*.yml» в папке                  |
| «installation-scripts\\playbooks\\group_vars»                        |
|                                                                      |
| **ip_хоста ansible_connection**=\<*тип подключения\>*                |
| **ansible_user**=\<*имя пользователя\>*                              |
+----------------------------------------------------------------------+

Пример файла dev_hosts:

  ------------------------------------------------------
  **\[dev\]\
  localhost ansible_connection=local\
  localhost ansible_connection=ssh ansible_user=root**

  ------------------------------------------------------

### Запуск установки адаптеров

> Для запуска установки адаптеров необходимо перейти в папку
> «installation-scripts» в папке, куда был распакован дистрибутив ИМ /
> МЭИМ, и выполнить команду:

  -------------------------------------------------
  ansible-playbook playbooks/script.yml --i hosts
  -------------------------------------------------

, где:

-   **«**hosts**»** -- имя файла с перечнем целевых хостов, на которые
    должна производится установка;

-   «script.yml» -- имя файла скрипта, который необходимо выполнить для
    запуска той или иной конфигурации установки. Варианты скриптов
    перечислены в Таблице 4.

**Таблица** **4. Список скриптов**

  **Название скрипта**                   **Выполняемые операции**
  -------------------------------------- -------------------------------------------------------------------------------------------------
  **im_full.yml**                        Полная установка адаптеров. При этом старый репозиторий и все конфигурации адаптеров удаляются.
  **im_full_with_restart.yml**           То же, что и «im_full», но с перезапуском сервера приложений.
  **im_patch.yml**                       Установка адаптеров, адаптеры заменяются только в случае совпадении имен.
  **im_patch_with_restart.yml**          То же, что и «im_patch», но с перезапуском сервера приложений
  **im_configurator.yml**                Установка адаптеров в Конфигуратор
  **im_configurator_with_restart.yml**   То же, что и «im_configurator», но с перезапуском сервера приложений
  **im_generate.yml**                    Генерация property-файла
  **server_stop.yml**                    Остановка сервера приложений
  **server_start.yml**                   Запуск сервера приложений

## Установка ИМ в Конфигураторе

Для работы с Hyperic HQ предварительно необходимо получить учетную
запись в ЦИ с ролями «Администратор конфигураций» и «Администратор точек
взаимодействий» для артефакта «Интерфейсный модуль».

**ВНИМАНИЕ!**

Если установка ИМ / МЭИМ выполняется в GreenField, необходимо до
установки в директории «environment» дистрибутива ИМ / МЭИМ удалить
исходный файл «whitelist.xml» и изменить название файла
«whitelist_greenfield.xml» на «whitelist.xml».

Для установки ИМ / МЭИМ необходимо внести библиотеки адаптеров и api в
репозиторий интеграционного модуля. Для этого:

\- из директории дистрибутива скопируйте папку «integrator-repository» в
папку на сервере, например, «/usr/meim». Для пользователя, под которым
на данном сервере запущен СП WildFly, должны быть установлены права на
чтение из данной папки;

\- зайдите в консоль конфигурации Hyperic HQ ядра ППРБ, к которому
подключается ИМ / МЭИМ. Если в списке артефактов Конфигуратора ППРБ нет
элемента «Интерфейсный модуль -- (Integrator)», то необходимо
импортировать модель конфигурации интерфейсного модуля. Импорт
выполняется с помощью пользовательского интерфейса Конфигуратора: в
консоли конфигурации Hyperic HQ в главном меню выберите пункт меню
**Resources \> Конфигуратор ППРБ** (см. Рисунок 5).

![](media/image12.png){width="3.2869564741907262in"
height="2.5123097112860893in"}

> Рисунок 7

На открывшейся странице нажмите кнопку «Импорт модели» и далее
импортировать файлы моделей конфигурации (см. Рисунок 6).

![](media/image13.png){width="6.486805555555556in"
height="4.414583333333334in"}

> Рисунок 8

Для каждой модели конфигурации выберите соответствующий файл из папки
«**config-struct»** дистрибутива ИМ и нажать кнопку **«Отправить»**.

Необходимо импортировать следующие файлы:

-   integrator-config-struct.xml -- файл конфигурации Интегратора;

-   integrator-platform-config-struct.xml -- файл конфигурации группы
    > серверов интерфейсного модуля;

-   smtp-transport-config-struct.xml - файл модели конфигурации
    > smtp-транспорта;

-   esb-transport-config-struct.xml -- файл модели конфигурации
    > MQ-транспорта;

-   soap-transport-config-struct.xml -- файл модели конфигурации
    > SOAP-транспорта;

-   file-transport-config-struct.xml -- файл модели конфигурации
    > файлового транспорта;

-   jdbc-transport-config-struct.xml - файл модели конфигурации
    > JDBC-транспорта.

Также из папки «**config-struct»** дистрибутива ИМ необходимо
импортировать все дополнительные универсальные настройки адаптеров
(например: ucp-oip-corp-adapter-config-struct.xml,
ucp-oip-retail-adapter-config-struct.xml).

Таким образом, из папки «**config-struct»** дистрибутива ИМ необходимо
импортировать все файлы.

**ВНИМАНИЕ!**

Если модель уже была импортирована, будет выведено сообщение, что такая
модель уже существует. В этом случае можно выполнить донастройку уже
существующей конфигурации.

## Настройка ИМ в Конфигураторе

Для настройки ИМ / МЭИМ в консоли конфигурации Hyperic HQ в главном меню
выберите пункт меню **Resources \> Конфигуратор ППРБ** (см. Рисунок 7).

![](media/image12.png){width="3.2869564741907262in"
height="2.5123097112860893in"}

Рисунок 9

На открывшейся странице будет список артефактов конфигурации (см.
Рисунок 8).

![](media/image14.png){width="6.486805555555556in"
height="2.1215277777777777in"}

Рисунок 10

Для настройки ИМ / МЭИМ работа ведется с элементом **«Интерфейсный
модуль**» (**Integrator**).

### Настройка артефакта для ИМ

#### Параметры кэша (Cache)

GridGain используется для внутренних распределенных кэшей, которые
хранят в себе метаинформацию для корреляции сообщений (объекты
ReplybackId, необходимые межмодульному транспорту для доставки ответов
на исходящие из ППРБ запросов, когда запрос отправляется с одного узла,
а ответ приходит на другой).

Необходимо выполнить настройку в соответствии с Рисунок 11.

![](media/image15.png){width="6.488194444444445in"
height="1.9520833333333334in"}

Рисунок 11

#### Кластер (Cluster)

Для организации кластерного режима работы интеграционного модуля
требуется хранение списка адресов узлов кластера. Каждый элемент
кластера должна быть описан строкой следующего вида: \<адрес
узла\>:\<порт\>

Строка состоит из следующих параметров:

-   \<адрес узла\> -- IP-адрес узла кластера или его DNS-имя;

-   \<порт\> -- порт, по которому происходит синхронизация
    распределенного кэша интеграционного модуля. По умолчанию,
    используется порт 10800.

Необходимо выполнить настройку в соответствии с Рисунок 12.

![](media/image16.png)  

Рисунок 12

**Примечание:**

в подразделе настроек кластера «ipAddressesSecondCluster» необходимо
внести данные (ip-адрес/DNS и порт) по каждому узлу резервного
кластера.**\
**Настройки для работы в режиме Stand-In

Для возможности работы ИМ / МЭИМ в режиме Stand-In в Конфигураторе на
уровне Root должны быть добавлены настройки (см. Рисунок 13):

![](media/image17.png)  

Рисунок 13

Описание настроек:

**SSLSocketFactory** -- группа настроек ssl для клиента вызова Rest Api
консоли мастера StandIn:

**SSLSocketFactory/keyStore** - путь до хранилища ключей;

**SSLSocketFactory/keyStorePassword** - пароль на хранилищей ключей;

**SSLSocketFactory/privateKeyPassword** - пароль на закрытый ключ;

**SSLSocketFactory/keyStoreType** - тип хранилища (PKCS12/JKS);

**SSLSocketFactory/trustStore** - путь до доверенного хранилища
сертификатов;

**SSLSocketFactory/trustStorePassword** -- пароль на доверенное
хранилище;

**SSLSocketFactory/trustStoreType** -- тип хранилища (PKCS12/JKS);

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

**enableStandIn -** признак включения функционала «Stand-In», по
умолчанию «false»;

**url_connection_masterStandIn** - URL rest-сервиса консоли мастера
Stand-In;

**isStandIn** -- признак того, что интегратор работает в контуре StandIn
ППРБ, по умолчанию «false».

Также для каждой точки взаимодействия (Points) добавлена настройка:

**ignoredWorkMode** -- режим ИМ/МЭИМ ППРБ, в котором остановка адаптера
игнорируется. Возможные значения: «STOP_FRONT», «STOP_ALL», «UNDEFINED»,
значение по умолчанию -- «UNDEFINED».

**ПРИМЕЧАНИЕ:**

«STOP_FRONT» - режим работы ИМ / МЭИМ ППРБ, при котором он не принимает
запросы от внешних АС;

«STOP_ALL» - режим работы ИМ / МЭИМ ППРБ, при котором он не принимает
любые запросы и ответы от внешних АС и от ПМ ППРБ;

«UNDEFINED» - режим работы ИМ / МЭИМ ППРБ, в котором остановка адаптера
игнорируется, не задан.

Для включения функционала Stand-In необходимо:

в параметре «**enableStandIn**» задать значение «true»;

в параметре «**url_connection_masterStandIn»** задать URL rest-сервиса
консоли мастера Stand-In;

в параметре «**isStandIn**» задать значение «false», если ИМ/МЭИМ ППРБ
запускается в основном контуре ППРБ, или «true», если в контуре Stand-In
ППРБ.

#### Точки взаимодействия - адаптеры (Points)

В данной группе описываются настройки всех входящих и исходящих
взаимодействий, т.е. настройки всех адаптеров, которые содержатся в ИМ и
реализуют эти взаимодействия. Заполнение настроек данной группы вручную
может быть очень трудоемкким, поэтому существует возможность сделать это
автоматически. Для этого необходимо подготовить файл настроек
конфигурации \*.properties и загрузить его в конфигуратор. Для загрузки
файла перейдите на страницу нужной версии артефакта и нажмите кнопку
![](media/image18.png){width="0.2520833333333333in"
height="0.2263888888888889in"} у корневого элемента дерева настроек (см.
Рисунок 12),

![](media/image19.png){width="6.486805555555556in"
height="3.582638888888889in"}

Рисунок 14

В открывшемся модальном окне выбрать нужный файл \*.properties и нажать
кнопку **«Подача запроса»** (см. Рисунок 13).

![](media/image20.png)  

Рисунок 15

Файл настроек конфигурации можно создать автоматически на основе
репозитория адаптеров, который включен в состав дистрибутива ИМ. Для
этого необходимо на сервере, на который установлен Ansible, запустить
выполнение скрипта «**im_generate.yml»** (см. подраздел 6.4.3 [Запуск
установки адаптеров](#запуск-установки-адаптеров)) и вручную
импортировать полученный файл настроек в Конфигуратор.

#### Настройка адаптеров для файлового транспорта

**ПРИМЕЧАНИЕ:**

Данные настройки должны быть выполнены для адаптеров ИМ:

**tfs-downloadfile-out-adapter,**

**tfs-uploadfile-out-adapter**

1\) Предварительно Администратором ИМ на сервере с ИМ ППРБ должны быть
монтированы папки ТФС, используемые для загрузки и выгрузки файлов из/в
ТФС. Список папок находится в файле «**environment/qa.xml**» в составе
дистрибутива ИМ.

**ПРИМЕЧАНИЕ:**

При загрузке конфигурации адаптера «**tfs-downloadfile-out-adapter**» в
Конфигуратор ППРБ, в настройку «**incomeByNotifyFolders**» добавляются
пути до подмонтированных папок в фомате «scenarioId=путь до папки», где
scenarioId - id сценария взаимодействия (см. Рисунок 14).

При загрузке конфигурации адаптера «**tfs-uploadfile-out-adapter**» в
Конфигуратор ППРБ, в настройку «destinationList» добавляются пути до
подмонтированных папок в фомате «scenarioId=путь до папки», где
scenarioId - сценарий взаимодействия (см. Рисунок 15).

![](media/image21.png){width="6.496527777777778in"
height="1.7366087051618548in"}

Рисунок 16

![](media/image22.png){width="6.4951531058617675in"
height="1.0720002187226596in"}

Рисунок 17

2\) Необходимо прописать путь до папки, содержащей файлы БОК, в
настройке «pathFolderBOK» файлового транспорта в Конфигураторе ППРБ (см.
Рисунок 16).

![](media/image23.png){width="6.496527777777778in"
height="0.9145691163604549in"}

Рисунок 18

В данной папке должны находиться файлы БОК с сертификатами от всех
закрытых ключей, подпись которыми будет проверяться на ИМ.

3\) Также, если в процессе работы адаптера будет необходима подпись
выгружаемого файла, то необходимо задать значения параметров настройки
подключения к ФПСУ (см. Рисунок 17):

**fpsuAddr --** IP-адрес ФПСУ;

**fpsuPort --** порт;

**fpsuTimeout --** таймаут в миллисекундах;

**fpsuKeyNum --** номер ключа.

![](media/image24.png){width="6.488194444444445in"
height="0.5229166666666667in"}

Рисунок 19

### Настройка артефакта для МЭИМ

При установке МЭИМ необходимо настроить перекрытие для МЭИМ в
конфигурации интерфейсного модуля. Для этого в списке артефактов
выберите элемент **«Интерфейсный модуль»**, перейдите по ссылке с его
названием и нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"}рядом с загруженной версией конфигурации
(см. Рисунок 18).

![](media/image26.png){width="6.436139545056868in"
height="2.3490562117235347in"}

Рисунок 20

На открывшейся странице задайте название подгруппы для конфигурации (см.
Рисунок 19) и нажмите кнопку **«Сохранить»**.

> ![](media/image27.png){width="5.765629921259842in"
> height="2.876033464566929in"}

Рисунок 21

Перейдите в секцию настройки Интерфейсного модуля в только что созданную
группу для донастройки (см. Рисунки 20,21,22).

![](media/image28.png)  

Рисунок 22

> ![](media/image29.png){width="4.873846237970254in"
> height="0.496000656167979in"}

Рисунок 23

![](media/image30.png){width="6.486805555555556in"
height="2.5131944444444443in"}

Рисунок 24

Далее выполните все шаги п.5.4.1 [Настройка артефакта для
ИМ](#настройка-артефакта-для-им), используя дистрибутив МЭИМ.

**ПРИМЕЧАНИЕ:**

Адаптеры **esbms-ucs-in-adapter** и **esbms-ucs-out-adapter** должны
быть зарегистрированы в конфигураторе по два раза под разные настройки
ЕКС (два абонента -- две пары очередей). При необходимости дублирования
настроек данного адаптера вручную можно использовать функцию экспорта и
импорта конфигурации в Конфигураторе ППРБ.

Настройка для файлового транспорта для МЭИМ выполняется для адаптеров:

**meim-tfs-downloadfile-out-adapter,**

**meim-tfs-uploadfile-out-adapter.**

### Ручная настройка адаптеров (необязательный пункт)

В определенных случаях может понадобиться ручная настройка адаптеров в
Конфигураторе ППРБ. Ниже приведены примеры создания конфигурации для
входящего и исходящего адаптеров (на примере адаптеров для
JDBC-транспорта).

#### Ручная настройка исходящего адаптера

Перейдите в текущую конфигурацию Интегратора в Hyperic HQ в раздел
«**Root/Points/External**» и кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} (см. Рисунок 23).

![](media/image31.png){width="6.496527777777778in"
height="1.9578762029746282in"}

Рисунок 25

Введите значения параметров:

**adapterName** -- наименование адаптера;

**adapterVersion** -- версия адаптера (можно взять из названия файла
самого адаптера в составе дистрибутива ИМ);

**isStart** - признак автоматического запуска адаптера старте ИМ, по
умолчанию -- «false»;

**validateOn** -- признак включения валидации запросов и ответов,
обрабатываемых адаптером;

**ignoredWorkMode** -- режим ИМ/МЭИМ ППРБ, в котором остановка адаптера
игнорируется. Возможные значения: «STOP_FRONT», «STOP_ALL», «UNDEFINED»,
значение по умолчанию -- «UNDEFINED» (см. Рисунок 24).

  -- -- -- --
           
  -- -- -- --

![](media/image32.png)  

Рисунок 26

Далее нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} на пункте «integrator-transport». В
появившемся диалоговом окне выберите «jdbc-transport (\<version\>)».

Перейдите на следующий уровень конфигурации, нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} на пункте «TLJDBC», нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"}на пункте «Connection», и создайте группу
с названием «1».

Добавьте значения настроек конфигурируемого адаптера (см. Рисунок 25).

![](media/image33.png){width="6.496527777777778in"
height="2.559990157480315in"}

Рисунок 27

, где:

**JDBCUrl** -- URL экземпляра базы данных внешней системы. Обязательный
элемент;

**user** -- имя пользователя базы данных внешней системы. Обязательный
элемент;

**password** -- пароль пользователя базы данных внешней системы.
Обязательный элемент;

**acquireIncrement** -- количество соединений, которые будут добавлены в
пул, когда текущее количество открытых соединений будет исчерпано. По
умолчанию равно 4. Опциональный элемент;

**acquireRetryAttempts** -- определяет количество попыток получить
соединение. Значение по умолчанию - 30. Опциональный элемент;

**acquireRetryDelay** -- интервал между попытками получить соединение (в
миллисекундах). Значение по умолчанию - 1000. Опциональный элемент;

**breakAfterAcquireFailure** -- прекращение попыток получить соединение.
Значение по умолчанию - false. Опциональный элемент;

**idleConnectionTestPeriod** -- период между проверками соединений на
бездействие (в секундах). Параметр активен при значении больше 0.
Значение по умолчанию -- 5. Опциональный элемент;

**initialPoolSize** -- количество соединений в пуле при старте. Значение
должно быть не меньше минимального и не больше максимального количества.
По умолчанию равно 2. Опциональный элемент;

**initSql** -- SQL-выражение, выполняемое при открытии соединения пулом.
Опциональный элемент;

**JDBCTransactionDefTimeout** -- таймаут по умолчанию для JDBC
Transaction Manager (в секундах). Значение по умолчанию -- 0.
Опциональный элемент;

**maxConnectionAge** -- время жизни соединения (в секундах), после
которого соединение будет закрыто и удалено из пула. Значение по
умолчанию -- 0 (время жизни не ограничено). Опциональный элемент;

**maxIdleTime** -- определяет время простоя соединения (в секундах),
после которого это соединение будет закрыто и удалено из пула. По
умолчанию равно 180. Опциональный элемент;

**maxPoolSize** -- максимальное количество соединений в пуле. По
умолчанию равно 10. Опциональный элемент;

**minPoolSize** -- минимальное количество соединений в пуле. По
умолчанию равно 2. Опциональный элемент;

**unreturnedConnectionTimeout** -- определяет, через какое количество
секунд соединение будет принудительно завершено. Предназначен для
предотвращения утечек памяти. Параметр активен только при значении
больше 0. Значение по умолчанию -- 0. Опциональный элемент;

**internalModuleId --** идентификатор модуля ППРБ, участвующего во
взаимодействии. Значение поля «module.id» из файла
«module-config.properties» прикладного модуля ППРБ. Обязательный
элемент;

**externalSystemId --** идентификатор внешней системы, участвующей во
взаимодействии. Задается по шаблону: urn:sbrfsystems:\<Код
ТБ\>-\<Идентификатор системы\>:\<Идентификатор экземпляра системы (при
необходимости)\>. Обязательный элемент.

**\`**

Значения настроек можно взять из соответствующего раздела
«**destination**» файла «**environment/qa.xml**» в составе дистрибутива
ИМ. Наименование раздела «**destination**» можно найти в файле списка
адаптеров «**environment/whitelist.xml**» в строке для соответствующего
адаптера.

Если какого-то параметра (например, «internalModuleId») в «destination»
нет, значит он находится в xml-файле конфигурации адаптера
(«integrator-repository\\out-adapters» в составе дистрибутива ИМ),
например:

\<adapter xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"
xsi:noNamespaceSchemaLocation=\"../../schema/adapter.xsd\"\>

\<jdbc-transport\>

\<**internalModuleId**\>eks-srv-account-out-adapter\</**internalModuleId**\>

\</jdbc-transport\>

\</adapter\>

После ввода всех настроек нажмите кнопку «**Сохранить всё**».

#### Ручная настройка входящего адаптера

Перейдите в текущую конфигурацию Интегратора в Hyperic HQ в раздел
«**Root/Points/Internal**» и кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} (см. Рисунок 26).

![](media/image34.png){width="6.496527777777778in"
height="1.6883333333333332in"}

Рисунок 28

Введите значения параметров:

**adapterName** -- наименование адаптера;

**adapterVersion** -- версия адаптера (можно взять из названия файла
самого адаптера в составе дистрибутива ИМ);

**isStart** - признак автоматического запуска адаптера старте ИМ, по
умолчанию -- «false»;

**validateOn** -- признак включения валидации запросов и ответов,
обрабатываемых адаптером;

**ignoredWorkMode** -- режим ИМ/МЭИМ ППРБ, в котором остановка адаптера
игнорируется. Возможные значения: «STOP_FRONT», «STOP_ALL», «UNDEFINED»,
значение по умолчанию -- «UNDEFINED» (см. Рисунок 24).

Далее нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} на пункте «integrator-transport». В
появившемся диалоговом окне выберите «jdbc-transport (\<version\>)».

Перейдите на следующий уровень конфигурации, нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} на пункте «TLJDBC», нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"}на пункте «Connection», и создайте группу
с названием «1».

Добавьте значения настроек конфигурируемого адаптера (см. Рисунок 27).

![](media/image35.png){width="6.496527777777778in"
height="3.439692694663167in"}

Рисунок 29

Значения настроек можно взять из соответствующего раздела
«**destination**» файла «**environment/qa.xml**» в составе дистрибутива
ИМ. Наименование раздела «**destination**» можно найти в файле списка
адаптеров «**environment/whitelist.xml**» в строке для соответствующего
адаптера.

Если какого-то параметра (например, «internalModuleId») в «destination»
нет, значит он находится в xml-файле конфигурации адаптера
(«integrator-repository\\out-adapters» или
«integrator-repository\\in-adapters» в составе дистрибутива ИМ),
например:

\<adapter xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"
xsi:noNamespaceSchemaLocation=\"../../schema/adapter.xsd\"\>

\<jdbc-transport\>

\<**internalModuleId**\>eks-srv-account-out-adapter\</**internalModuleId**\>

\</jdbc-transport\>

\</adapter\>

  -- -- -- --
           
  -- -- -- --

Далее нажмите кнопку
![](media/image25.png){width="0.29583333333333334in"
height="0.26944444444444443in"} на пункте «inboundQueryExecutors»,
создайте группу с названием «1» и сделайте настройку параметров в
соответствии с xml-файлом конфигурации адаптера
(«integrator-repository\\out-adapters» в составе дистрибутива ИМ):

![](media/image36.png){width="6.496527777777778in"
height="0.9822900262467191in"}

Рисунок 30

После ввода всех настроек нажмите кнопку «**Сохранить всё**».

### SSL-аутентификация

Чтобы настроить SSL-аутентификацию во взаимодействии ИМ / МЭИМ с IBM
WebSphere MQ, необходимо выполнить следующие шаги:

-   подготовить сертификат и хранилище ключей;

-   настроить SSL-аутентификацию в IBM WebSphere MQ;

-   Сконфигурировать транспортную библиотеку интеграционного модуля.

> Сертификаты, которые необходимо подготовить:

-   для ИМ:

*CN=00CA0001CPPRBIMprb99usr, OU=00CA, O=Savings Bank of the Russian
Federation,C=RU;*

-   для МЭИМ:

*CN=00CA0001CAesbmsusr,OU=00CA,O=Savings Bank of the Russian
Federation,C=RU.*

Подробности настройки SSL-аутентификации приведены в документе
«Взаимодействие с внешними системами» (см. Таблицу 2 подраздела
[Связанные документы](#_Связанные_документы)) в разделе «Стандартные
транспортные библиотеки» / «Взаимодействие с КСШ» / «Безопасность».

###  Параметры транспортной библиотеки MQ (необязательный пункт)

При необходимости ручной настройки транспортной библиотеки MQ в
Конфигурации ИМ / МЭИМ в Конфигураторе ППРБ нужно заполнить следующие
параметры:

-   **«hostName»** -- имя хоста или IP-адрес сервера, на котором
    установлена платформа IBM WebSphere MQ, обязательный элемент;

-   **«port»** -- порт, через который устанавливаются подключения к IBM
    WebSphere MQ;

-   **«queueManager»** -- имя администратора очередей, который содержит
    очереди входящих и исходящих сообщений, обязательный элемент;

-   **«channel»** -- имя канала, по которому приложения взаимодействуют
    с администратором очереди, обязательный элемент;

-   **«outboundQueue»** -- имя очереди, в которую записываются сообщения
    от прикладного модуля к внешней системе, обязательный элемент;

-   **«inboundQueue»** -- имя очереди, в которую записываются сообщения
    от внешней системы к прикладному модулю, обязательный элемент;

-   **«jmsMessageBodyType»** -- тип передаваемого сообщения. Может
    принимать следующие значения:

    -   text -- тело сообщения передаётся в виде строки текста;

    -   bytes -- тело сообщения передаётся в виде массива байтов;

    -   bytesWithBOM -- тело сообщения передаётся в виде массива байтов.
        > Кроме того, при передаче сообщения в MQ к телу добавляется BOM
        > (Byte Order Mark), а при получении сообщения из MQ из тела
        > удаляется BOM (Byte Order Mark);

-   **«sslCipherSuite»** -- используемый метод шифрования SSL (SSL
    Cipher Suite). Опциональный элемент. Необходим при использовании
    SSL-аутентификации. Значение параметра должно соответствовать
    значению CipherSpec на используемом канале IBM WebSphere MQ. За
    подробностями обратитесь к подразделу 6.6.3
    [SSL-аутентификация](#ssl-аутентификация);

-   **\"sslPeerName\"** -- имя сертификата (SSLPeerName), используемого
    администратором очередей IBM WebSphere MQ (например,
    *CN=00CA0001CESBm99.esb.adp.bo1, OU=00CA, O=Savings Bank of the
    Russian Federation, C=RU*). Позволяет ограничить подключения только
    к администраторам очередей, имеющим сертификат с указанным именем.

Более подробно о параметрах транспорта и его настройке описано в
документе «Взаимодействие с внешними системами» (см. Таблицу 2
подраздела [Связанные документы](#_Связанные_документы)) в разделе
«Стандартные транспортные библиотеки» / «Взаимодействие с КСШ» /
«Параметры транспортной библиотеки».

### Обновление настроек интеграционного взаимодействия

Применение общих настроек ИМ в Конфигураторе требует рестарта
приложения. Изменение настроек адаптеров можно выполняется «на лету».

Перезапускать, обновлять версию адаптера, менять его конфигурацию можно
без перезапуска всего приложения. Перезапускать, запускать или
останавливать конкретный адаптер можно двумя способами:

-   Через Конфигуратор. В Конфигураторе можно изменить любые настройки
    адаптера и с помощью кнопки применения настроек (зеленая галочка)
    передать новую конфигурацию на узлы ИМ, использующие эту
    конфигурацию (см. Рисунок 29). Для остановки и запуска адаптера
    через конфигуратор существует параметр **«isStart»**, который можно
    изменить с последующим применением конфигурации «на лету».

![](media/image37.png){width="6.495833333333334in"
height="0.8611111111111112in"}

Рисунок 31

Пример логов успешного перезапуска:

14:43:37 INFO c.s.i.ExternalSystem:132 - Запуск точки взаимодействия
GROUP завершен

14:43:37 INFO c.s.i.ExternalSystem:132 - Запуск точки взаимодействия
GROUP завершен

14:43:34 INFO c.s.i.Point:59 - Запуск точки взаимодействия GROUP

14:43:34 INFO c.s.i.ExternalSystem:158 - Остановка точки взаимодействия
GROUP завершена

14:43:34 INFO c.s.i.ExternalSystem:155 - Остановка транспорта завершена

14:43:34 INFO c.s.i.ExternalSystem:153 - Остановка транспорта \...

14:43:34 INFO c.s.i.ExternalSystem:150 - Остановка apiServer завершена

14:43:34 INFO c.s.i.ExternalSystem:148 - Остановка apiServer \...

14:43:34 INFO c.s.i.ExternalSystem:146 - Остановка точки взаимодействия
GROUP

14:43:34 INFO c.s.i.Point:59 - Запуск точки взаимодействия GROUP

14:43:34 INFO c.s.i.ExternalSystem:158 - Остановка точки взаимодействия
GROUP завершена

14:43:34 INFO c.s.i.ExternalSystem:155 - Остановка транспорта завершена

14:43:34 INFO c.s.i.ExternalSystem:153 - Остановка транспорта \...

14:43:34 INFO c.s.i.ExternalSystem:150 - Остановка apiServer завершена

14:43:34 INFO c.s.i.ExternalSystem:148 - Остановка apiServer \...

14:43:34 INFO c.s.i.ExternalSystem:146 - Остановка точки взаимодействия
GROUP \...

-   С помощью плагина консоли управления «Управление ИМ ППРБ». Он
    позволяет останавливать и запускать конкретные адаптеры на
    конкретных узлах, а также показывает их доступность. Плагин
    необходимо настроить в соответствии с документом «Руководство по
    установке и настройке ПО ТЯ ППРБ» (см. Таблицу 2 подраздела
    [Связанные документы](#_Связанные_документы)).

Дополнительно с работой сервиса конфигурации также можно ознакомиться в
документе «Руководство по установке и настройке ПО ТЯ ППРБ» (см. Таблицу
2 подраздела [Связанные документы](#_Связанные_документы)).

## Настройка MQ-транспорта для ИМ

**ВНИМАНИЕ!**

Установка и настройка транспортного слоя необходима только при
необходимости прямых взаимодействий между внешними АС (ЕФС) и ППРБ без
использования КСШ.

Предварительно на целевых серверах ИМ должен быть установлено ПО IBM MQ
7.5.0.5.

Для установки и настройки транспортного слоя MQ необходимо:

1\) убедиться, что на целевых серверах ИМ для каждого MQ-менеджера
(«M99.IM.GATEWAY.CLS1» и «M99.IM.GATEWAY.CLS2») создана файловая система
и пользователи «prb99usr», «ufs99usr», «dsa99usr», «dumbusr», «sv99usr»,
«ech99usr».

2\) Создать менеджеры очередей «M99.IM.GATEWAY.CLS1» и
«M99.IM.GATEWAY.CLS2» по правилам ОАСП c параметрами:

TCP:

KeepAlive=yes

Channels:

MaxChannels=1000

MQIBindType=FASTPATH

TuningParameters:

DefaultQBufferSize=67108864

DefaultPQBufferSize=67108864

Broker:

SyncPointIfPersistent=yes

SSL:

OCSPAuthentication=OPTIONAL

AllowSSLV3=y

QMErrorLog:

ErrorLogSize=2097152

3\) Скопировать все файлы из папки «mq/EFS/» в составе дистрибутива ИМ в
одну папку на целевом сервере.

4\) В файле «mq.properties», скопированном на сервер на предыдущем шаге,
задать актуальные значения параметров:

CLUSTER_NAME=\<Имя кластера\>

HOST_M99_IM_GATEWAY_CLS1=\<ip-адрес хоста для менеджера очередей 1\>

PORT_M99_IM_GATEWAY_CLS1=\<порт хоста для менеджера очередей 1\>

HOST_M99_IM_GATEWAY_CLS2=\<ip-адрес хоста для менеджера очередей 2\>

PORT_M99_IM_GATEWAY_CLS2=\<порт хоста для менеджера очередей 2\>

5\) На целевом сервере из папки, созданной при выполнении шага 3,
выполнить ОДИН раз исполняемые файлы:

./M99.IM.GATEWAY.CLS1.ksh,

./M99.IM.GATEWAY.CLS1_UPDATE_V025.ksh,

./M99.IM.GATEWAY.CLS1_UPDATE_V026.ksh,

./M99.IM.GATEWAY.CLS1_UPDATE_V027.ksh,

./M99.IM.GATEWAY.CLS1_UPDATE_V028.ksh,

./M99.IM.GATEWAY.CLS2.ksh,

./M99.IM.GATEWAY.CLS2_UPDATE_V025.ksh,

./M99.IM.GATEWAY.CLS2_UPDATE_V026.ksh,

./M99.IM.GATEWAY.CLS2_UPDATE_V027.ksh,

./M99.IM.GATEWAY.CLS2_UPDATE_V028.ksh.

Если ИМ должен содержать функционал, планируемый к внедрению в 3-ю
волну, необходимо выполнить также ОДИН раз исполняемые файлы:

M99.IM.GATEWAY.CLS1_UPDATE_WAVE3.ksh,

M99.IM.GATEWAY.CLS2_UPDATE_WAVE3.ksh.

По результатам выполнения данных файлов в текущей папке будут созданы
два файла-скрипта - M99.IM.GATEWAY.CLS1.mqs и M99.IM.GATEWAY.CLS2.mqs.

6\) Выполнить созданные на предыдущем шаге скрипты:

на сервере с MQ-менеджером «M99.IM.GATEWAY.CLS1»:

runmqsc M99.IM.GATEWAY.CLS1 \< M99.IM.GATEWAY.CLS1.mqs

, на сервере с MQ-менеджером «M99.IM.GATEWAY.CLS2»:

runmqsc M99.IM.GATEWAY.CLS2 \< M99.IM.GATEWAY.CLS2.mqs

7\) На целевом сервере из папки, созданной при выполнении шага 3,
выполнить ОДИН раз скрипты:

на сервере с MQ-менеджером «M99.IM.GATEWAY.CLS1»:

./M99.IM.GATEWAY.CLS1.RULES.sh,

./M99.IM.GATEWAY.CLS1_UPDATE_V025.RULES.sh,

./M99.IM.GATEWAY.CLS1_UPDATE_V026.RULES.sh,

./M99.IM.GATEWAY.CLS1_UPDATE_V027.RULES.sh,

./M99.IM.GATEWAY.CLS1_UPDATE_V028.RULES.sh,

а также M99.IM.GATEWAY.CLS1_UPDATE_WAVE3.RULES.sh, если ИМ должен
содержать функционал, планируемый к внедрению в 3-ю волну;

на сервере с MQ-менеджером «M99.IM.GATEWAY.CLS2»:

./M99.IM.GATEWAY.CLS2.RULES.sh,

./M99.IM.GATEWAY.CLS2_UPDATE_V025.RULES.sh,

./M99.IM.GATEWAY.CLS2_UPDATE_V026.RULES.sh,

./M99.IM.GATEWAY.CLS2_UPDATE_V027.RULES.sh,

./M99.IM.GATEWAY.CLS2_UPDATE_V028.RULES.sh,

а также M99.IM.GATEWAY.CLS2_UPDATE_WAVE3.RULES.sh, если ИМ должен
содержать функционал, планируемый к внедрению в 3-ю волну.

8\) Выпустить SSL-сертификаты для MQ-менеджеров «M99.IM.GATEWAY.CLS1» и
«M99.IM.GATEWAY.CLS2» с шифрованием - SSL_RSA_WITH_RC4_128_MD5.

Для каждого MQ-менеджера добавить выпущенный сертификат на
соответствующий сервер и произвести рестарт MQ-менеджера.

## Настройка MQ-транспорта для МЭИМ

Предварительно на целевых серверах МЭИМ должен быть установлено ПО IBM
MQ 7.5.0.5.

Для установки и настройки транспортного слоя MQ для МЭИМ необходимо:

1\) убедиться, что на целевых серверах для MQ-менеджера
«M99.ESBMS.GATEWAY1» создана файловая система и пользователи «ibs38usr»,
«ups99usr», «esbmsusr», «crm99usr», «cod99usr», «fs99usr», «ucp99usr»,
«vpl99usr», «dumbusr», «esbfs99usr», «cod3dvk99usr», «dm99usr»,
«afn99usr», «uvdousr».

2\) Создать менеджер очередей «M99.ESBMS.GATEWAY1» по правилам ОАСП c
параметрами:

TCP:

KeepAlive=yes

Channels:

MaxChannels=1000

MQIBindType=FASTPATH

TuningParameters:

DefaultQBufferSize=67108864

DefaultPQBufferSize=67108864

Broker:

SyncPointIfPersistent=yes

SSL:

OCSPAuthentication=OPTIONAL

AllowSSLV3=y

QMErrorLog:

ErrorLogSize=2097152

3\) Скопировать скрипты из папки «mq» в составе дистрибутива МЭИМ в одну
папку на целевом сервере.

4\) Выполнить скрипт:

runmqsc M99.ESBMS.GATEWAY1 \< M99.ESBMS.GATEWAY1.txt

5\) Выполнить скрипт M99.ESBMS.GATEWAY1.RULES.sh.

6\) Выпустить SSL сертификат для MQ менеджера M99.ESBMS.GATEWAY1 с
шифрованием - RC4_MD5_US SSL_RSA_WITH_RC4_128_MD5. Добавить выпущенный
сертификат на соответствующий сервер и произвести рестарт MQ-менеджера.
Пример DN выпущенного сертификата:

00CA0001CESBMSm99.esbms.gateway,OU=00CA,O=Savings Bank of the Russian
Federation,C=RU

## Установка СКЗИ БиКрипт

Для возможности автоматического подписания сообщений, передаваемых в/из
ИМ / МЭИМ на каждом узле интегратора должен быть установлен СКЗИ
БиКрипт.

Для установки БиКрипт необходимо:

-   создать произвольную папку на узле интегратора (например,
    > «/usr/bicript»);

-   в созданную папку скопировать все файлы из папки «bicr» дистрибутива
    > ИМ / МЭИМ. В состав дистрибутива ИМ / МЭИМ библиотеки взяты из
    > дистрибутива БиКрипт под распространенные версии Linux. Если
    > данные библиотеки не подходят под ОС сервера, на который
    > устанавливается ИМ / МЭИМ, то необходимо из фонда программного
    > обеспечения взять дистрибутив БиКрипт, который содержит библиотеки
    > для всех используемых версий Linux;

-   в файле «/home/\<Пользователь WF\>/.bash_profile» установить
    > переменную окружения:

LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/usr/lib:/usr/local/lib:/usr/WF/WF_PPRB/standalone/lib/ext

> , где
>
> «Пользователь WF» - пользователь, от имени которого запускается
> WildFly.
>
> Если в данной версии ОС Linux расположение папок с библиотеками
> другое, то в переменной окружения необходимо указывать актуальные пути
> до этих папок;

-   в папку «/usr/WF/WF_PPRB/standalone/lib/ext» скопировать все файлы
    > из папки «bicr» дистрибутива ИМ / МЭИМ.

## Настройка SSL для адаптеров

1)  Задать настройки SSL в файле профилей qa.xml, который расположен в
    подпапке «environment» папки, куда был распакован архив дистрибутива
    ИМ. (добавить тег «SSLSocketFactory»):

\<destination name=\"ubs\" parent=\"default

*   * \<esb-transport\>\
        \<hostName\>Sbt-oaar-370.ca.sbrf.ru\</hostName\>\
        \<port\>1501\</port\>\
        \<queueManager\>M99.UB.GATEWAY.CLS1\</queueManager\>\
        \<channel\>PPRB.IM.SVRCONN\</channel\>\
        \<sslCipherSuite\>SSL_RSA_WITH_RC4_128_MD5\</sslCipherSuite\>\
        \<sslPeerName\>CN=00CA0001CPPRBIMprb99usr,OU=00CA,O=Savings Bank
of the Russian Federation,C=RU\</sslPeerName\>

        \<SSLSocketFactory\>

               Protocol

               keyStore

               и т.д.

        \</SSLSocketFactory\>\
    \</esb-transport\>\
\</destination\>

Полный перечень настроек, которые необходимо добавить:

        \<group name=\"SSLSocketFactory\" minGroupCount=\"0\"
maxGroupCount=\"1\"\>

            \<description locale=\"ru_RU\" text=\"Настройки
SSLSocketFactory\"/\>

            \<enumProperty name=\"protocol\" required=\"false\"
defaultValue=\"SSLv3\" order=\"1\"\>

                \<description locale=\"ru_RU\" text=\"Протокол\"/\>

                \<value\>SSL\</value\>

                \<value\>SSLv3\</value\>

                \<value\>TLS\</value\>

                \<value\>TLSv1\</value\>

                \<value\>TLSv1.1\</value\>

                \<value\>TLSv1.2\</value\>

            \</enumProperty\>

            \<stringProperty name=\"keyStore\" required=\"true\"
order=\"2\"\>

                \<description locale=\"ru_RU\" text=\"Путь и имя файла
KeyStore. В keyStore должны находиться только личные сертификаты.\"/\>

            \</stringProperty\>

            \<stringProperty name=\"keyStorePassword\" required=\"true\"
protected=\"true\" order=\"3\"\>

                \<description locale=\"ru_RU\" text=\"Пароль
KeyStore\"/\>

            \</stringProperty\>

            \<enumProperty name=\"keyStoreType\" required=\"false\"
defaultValue=\"PKCS12\" order=\"4\"\>

                \<description locale=\"ru_RU\" text=\"Тип KeyStore\"/\>

                \<value\>PKCS12\</value\>

                \<value\>JKS\</value\>

            \</enumProperty\>

            \<stringProperty name=\"trustStore\" required=\"true\"
order=\"5\"\>

                \<description locale=\"ru_RU\" text=\"Путь и имя файла
TrustStore. В trustStore должны находиться только сертификаты
подписантов (своих сертификатов и сертификатов сервера MQ)\"/\>

            \</stringProperty\>

            \<stringProperty name=\"trustStorePassword\"
required=\"true\" protected=\"true\" order=\"6\"\>

                \<description locale=\"ru_RU\" text=\"Пароль
TrustStore\"/\>

            \</stringProperty\>

            \<enumProperty name=\"trustStoreType\" required=\"false\"
defaultValue=\"PKCS12\" order=\"7\"\>

                \<description locale=\"ru_RU\" text=\"Тип
TrustStore\"/\>

                \<value\>PKCS12\</value\>

                \<value\>JKS\</value\>

            \</enumProperty\>

            \<stringProperty name=\"sslCertAlias\" required=\"false\"
defaultValue=\"\" order=\"8\"\>

                \<description locale=\"ru_RU\" text=\"Алиас личного
сертификата, используемого для подключения к MQ. Указывается, если
хранилище содержит несколько личных сертификатов.\"/\>

            \</stringProperty\>

        \</group\>

# Задачи Администратора Kafka

Cо стороны администратора Kafka требуется выполнить установку и
настройку брокера сообщений Apache Kafka. Описание установки и настройки
Apache Kafka приведено в разделах 7 и 8 документа «Руководство по
администрированию Apache Kafka» (см. Таблицу 2 подраздела [Связанные
документы](#_Связанные_документы)).

# Настройка конфигуратора для распределения адаптеров по кластеру.

Оригинальное имя артифакта : integrator-platform

Список настраиваемых параметров:

    serverCount - Количество серверов интегратора в кластере.

    useBackupStrategy - Автоматически запускать резервную копию
адаптеров, значение по умолчанию true.

    useAutoDistribution - Включить автораспределение адаптеров по
кластеру, значение по умолчанию false (распределение адаптеров по
кластеру не происходит, интегратор запускает все адаптеры)

    Группа настроек ServerInformation:

        nodeId - Значения node.id инстансов интегратора(указанные через
запятую), для которых номер сервера равен serverId

        serverId - Номер сервера, начиная с 1

**Пример настроек в конфигураторе:**

![C:\\Users\\sbt-onohin-av\\Desktop\\конфигуратор.jpg](media/image38.jpeg){width="6.496527777777778in"
height="2.127798556430446in"}

В примере включено распределение адаптеров по кластеру с поднятием
резервных копий. Количество серверов по которым будут распределяться
адаптеры - 2.

Ноды integrator_1 и integrator_2 интегратора будут стартовать адптеры,
которые должны будут работать на первом сервере кластера.

На ноде integrator3 будут стартовать адаптеры, которые должны будуту
работать на втором сервере кластера.

**Проверка** **корректности** **полученных настроек при старте
итегратора:**

1.  Используются все идентификаторы серверов от 1 до serverCount.

2.  Отсутствие одинаковых значений nodeId с разными значениями serverId

3.  Наличие настройки nodeId, равной node.id инстанса интегратора

В случае, если настройки не проходят проверку, то на интеграторе будут
запускаться все адаптеры.
